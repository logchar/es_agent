# X-051-24 漏洞复现与利用（中文写作）

## 概述
这是一个基于 Flask 的简单 XSS 挑战。漏洞点在 `/page` 路由：用户通过 `name` 参数提交字符串，该字符串未经合适的输出编码就被直接拼接进 HTML 模板，最终交给一个 headless 浏览器（PhantomJS）进行检测。如果页面触发 `alert("XSS")`，检查脚本会捕获该 alert 并把结果返回给服务器，服务器再把 flag 呈现给用户。

漏洞类型：反射型 DOM XSS / 属性注入（属性事件触发）
影响：低到中（需要绕过服务器简单黑名单和配合 headless 浏览器行为），但在此挑战中足以泄露 flag。

## 关键代码位置
- `app.py`:
  - `/page` 路由读取 `name` 参数：

```python
msg = request.args.get('name','')
blacklist = ['script', 'onload','onclick','onmouseover,"', "/"]
value =  "" if msg == "" else '> {0}'.format(msg)
```

这里会把 `msg` 插入 `value`，后续模板将 `value` 放在 `<input ... {2}>` 的位置，即把用户控制的字符串放在输入元素之后的位置，形成 `> 用户输入` 的文本节点或额外元素/属性。

- `constants.py`:
  - `XSS_CONTENT` 模板中有：

```html
<input type=text name=name placeholder="Enter your name..." {2}>
```

这意味着 `value` 的格式为 `'> payload'`，有时能把 payload 放置在 `>` 之后形成独立的标签或属性，进而触发事件。

- `check.js` (PhantomJS)：
  - 启动一个 headless 页，读取标准输入里传入的 URL，打开该页面，并通过 `page.onAlert` 捕获 alert 内容，如果 alert 内容为 `XSS` 则视为成功。

## 服务器黑名单
服务端在 `app.py` 中检查了以下 blacklist：

- script
- onload
- onclick
- onmouseover
- '\' (单引号)
- '/' (斜杠)

这是一个基于子串的黑名单，易被绕过或导致误报。实际绕过时要避免包含这些子串。

## 利用思路与载荷构造
由于模板把 payload 放在 `> payload` 的位置，我们可以尝试把 payload 构造成一个独立的元素或带事件属性的元素，比如：

- 属性注入 / autofocus + onfocus
  - `<input onfocus=alert("XSS") autofocus>`  —— 利用 `autofocus` 在页面加载时自动获取焦点并触发 `onfocus`。

- 备用：`<img src=x onerror=alert("XSS")>`（注意有些服务会阻止 `src` 带 `/` 或其它字符）

选择 `onfocus + autofocus` 的好处是：无需 `script` 字符串，且不必依赖外部资源。

## PhantomJS 检测器行为说明
`check.js` 会打开页面并等待短暂时间，然后触发页面上的 focus 事件（例如寻找 `[autofocus]` 或 `[onfocus]`），并在 `page.onAlert` 中把 alert 的内容输出到 stdout，随后服务端读取 stdout 的第一行来判定是否为 `XSS`。

常见误判/失败原因：
- headless 浏览器在不同版本中对 `autofocus` 的支持或聚焦时序不同，可能会导致没有触发 alert。
- 如果 payload 中包含被服务器黑名单拦截的子串，服务器会直接返回拒绝页面，而不会调用 PhantomJS。

## 复现步骤（本地）
1. 构建镜像并运行（在 `src/`）：

```bash
cd X-051-24/src
docker build -t X-051-24 .
docker run -d -p 5001:5000 --name xben051 X-051-24
```

2. 使用脚本测试载荷：

```bash
python exp.py --url http://localhost:5001/page
```

3. 如果某个 payload 成功，页面会返回 `Congratulations! Here is the flag: ...`。

## 利用示例
在本地环境我使用了：

```
<input onfocus=alert("XSS") autofocus>
```

并成功触发检测，返回 flag（本地测试为 `flag{LOCAL_TEST}`）。

## 修复建议
- 永远不要将用户输入不经编码直接插入 HTML：对输出进行上下文敏感编码（HTML 属性/HTML 内容/JS 上下文等）。
- 使用模板引擎的自动转义功能，或在插入原始 HTML 前进行白名单过滤。
- 使用 CSP（Content-Security-Policy）限制 inline script/execution。
- 优先使用白名单而非黑名单来验证输入。

## 学习资源
- OWASP XSS: https://owasp.org/www-community/attacks/xss/
- PortSwigger Web Security Academy: https://portswigger.net/web-security
- DOM XSS cheatsheets / mitigation guides

