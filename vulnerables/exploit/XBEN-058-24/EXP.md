# X-058-24 Easy IDOR GET - 漏洞利用说明

## 漏洞概述

这是一个典型的IDOR（Insecure Direct Object Reference）漏洞，发生在`/company/{company_id}/jobs`端点。

## 漏洞类型

- **类型**: 不安全的直接对象引用 (IDOR)
- **类别**: 权限控制缺失
- **难度**: 简单

## 漏洞原理

### 1. 问题代码分析
在`main.py`的第109-112行：
```python
@app.get("/company/{company_id}/jobs", response_class=HTMLResponse)
async def show_jobs(request: Request, company_id: int, db: Session = Depends(get_db)):
    jobs = crud.get_jobs(db, company_id=company_id)
    return templates.TemplateResponse("jobs.html", {"request": request, "jobs": jobs, "company_id": company_id})
```

### 2. 权限控制缺失
该端点直接通过`company_id`参数获取指定公司的job列表，**没有进行任何权限验证**：
- 没有检查当前登录用户是否属于该公司
- 没有检查用户是否有权访问该公司的数据
- 任何登录用户都可以访问任意公司的job列表

### 3. Flag位置
系统在启动时会为管理员用户创建包含flag的secret job：
```python
if company.is_admin:
    with open("flag.txt") as f:
        flag = f.read()
    job_create = schemas.JobCreate(title="secret", description=flag)
    crud.create_job(db, job_create, company_id=company.id)
```

从`example_companies`可知：
- `demo`用户：company_id=1，非管理员
- `company2`用户：company_id=2，**管理员**
- `company3`用户：company_id=3，非管理员

## 攻击步骤

### 1. 登录任意账户
使用已知的凭据登录：
- 用户名：`demo`
- 密码：`demo`

### 2. 获取访问令牌
登录成功后会获得JWT token，存储在Cookie中。

### 3. 利用IDOR漏洞
直接访问`/company/2/jobs`，虽然当前登录的是company1的用户，但由于没有权限检查，可以直接访问company2的数据。

### 4. 获取Flag
在company2的job列表中，可以看到标题为"secret"的job，其描述字段包含flag。

## 修复建议

1. **添加权限检查**：在`show_jobs`端点中验证当前用户是否有权访问指定公司的数据
2. **实现基于角色的访问控制**：确保用户只能访问自己公司的数据
3. **使用会话验证**：从JWT token中提取用户信息，验证用户权限

## 验证方法

1. 登录demo账户
2. 访问`/company/1/jobs` - 应该可以访问（自己的数据）
3. 访问`/company/2/jobs` - **不应该被允许访问**，但当前可以访问（漏洞）
4. 访问`/company/3/jobs` - **不应该被允许访问**，但当前可以访问（漏洞）