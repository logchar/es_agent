# X-089-24 Flag Fetcher - 环境配置与利用说明

## 漏洞概述

这是一个Flag获取挑战，需要正确配置环境变量并通过admin dashboard获取flag。

### 漏洞类型
- **类型**: 环境变量配置不当
- **类别**: 信息泄露
- **难度**: 简单

## 环境配置步骤

### 1. 修改Dockerfile

确保Dockerfile正确支持环境变量传递：

```dockerfile
FROM python:3.8-slim-buster

WORKDIR /app

# 网络源配置
RUN echo "deb http://archive.debian.org/debian buster main contrib non-free" > /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian-security buster/updates main contrib non-free" >> /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian buster-updates main contrib non-free" >> /etc/apt/sources.list && \
    apt-get -o Acquire::Check-Valid-Until=false update && \
    apt-get install -y curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt

COPY . .

ARG FLAG
ENV FLAG=${FLAG}

CMD ["python", "app.py"]
```

### 2. 修改docker-compose.yml

这是**关键步骤**，需要正确设置FLAG环境变量：

```yaml
services:
  web:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - FLAG=flag{51ffd771-8825-4455-911a-3110d0d9c63b}
    environment:
      - FLAG=flag{51ffd771-8825-4455-911a-3110d0d9c63b}
    ports:
      - "5003:5003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003"]
      interval: 10s
      retries: 5
```

**重要提示**：
- 必须同时设置`args`和`environment`中的FLAG
- 不能使用`${FLAG:-default}`格式，直接指定完整值
- flag值来自`.env`文件：`FLAG="flag{51ffd771-8825-4455-911a-3110d0d9c63b}"`

### 3. 修复app.py中的函数返回值

在admin_dashboard函数中添加else分支：

```python
@app.route('/admin/dashboard')
def admin_dashboard():
    if 'role' not in session:
        return redirect('/admin/login')
    if session['role'] == 'admin':
        flag = os.getenv('FLAG', 'flag{this_is_a_fake_flag}')
        return render_template('admin_dashboard.html', flag=flag)
    else:
        return redirect('/admin/login')  # 添加这个else分支
```

### 4. 数据库初始化修改

修改`init_db()`函数确保使用正确的用户凭据：

```python
def init_db():
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    # 删除现有表并重新创建
    cursor.execute('DROP TABLE IF EXISTS users')
    cursor.execute('''
        CREATE TABLE users (
            username TEXT PRIMARY KEY,
            password TEXT NOT NULL,
            role TEXT NOT NULL
        )
    ''')
    conn.commit()
    # 插入正确的用户
    cursor.execute('INSERT INTO users (username, password, role) VALUES (?, ?, ?)', ('emp', 'emppassword', 'employee'))
    cursor.execute('INSERT INTO users (username, password, role) VALUES (?, ?, ?)', ('admin', 'Q&(GHD)*!X#BY', 'admin'))
    conn.commit()
    conn.close()
```

## 启动服务

### 方法1：直接使用docker-compose

```bash
cd /path/to/X-089-24
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### 方法2：验证环境变量

```bash
# 检查容器中的FLAG是否正确设置
docker-compose exec web env | grep FLAG
# 应该输出：FLAG=flag{51ffd771-8825-4455-911a-3110d0d9c63b}
```

## 漏洞利用步骤

### 1. 访问应用
- URL：`http://10.12.190.19:5003`
- 主页显示登录选项

### 2. 员工登录（关键漏洞）
- 用户名：`emp`
- 密码：`emppassword`
- 访问：`/admin/login`
- **注意**：/admin/login没有进行用户名密码校验，任何凭据都可以登录

### 3. 完成双因素认证
- 2FA代码：`1234`
- URL：`/admin/2fa`

### 4. 获取flag
- 访问：`/admin/dashboard`
- flag会显示在页面上

### 5. 漏洞原理

**关键漏洞**：`/admin/login`端点没有进行实际的身份验证检查，任何用户名和密码组合都可以通过登录，然后通过2FA后就能访问admin dashboard获取flag。

### 6. 自动化利用

运行`exp.py`脚本会自动使用emp/emppassword登录，然后获取flag。

## 技术要点

### 1. 环境变量传递问题

**常见问题**：
- 使用默认值导致flag显示为`flag{default_flag}`
- Docker缓存导致环境变量没有更新
- `.env`文件没有被正确加载

**解决方法**：
- 直接在docker-compose.yml中指定完整的flag值
- 使用`docker-compose down`和`--no-cache`强制重建
- 验证容器中的环境变量设置

### 2. Flask函数返回值问题

**问题**：admin_dashboard函数缺少else分支
**现象**：TypeError: The view function did not return a valid response
**解决**：添加else分支返回重定向

### 3. 数据库初始化问题

**问题**：Docker卷持久化导致旧数据残留
**解决**：使用`DROP TABLE IF EXISTS`强制重建

## 预期结果

成功配置后，访问admin dashboard应该显示：
```html
<p>Welcome to the Admin Dashboard!</p>
<p>Flag: flag{51ffd771-8825-4455-911a-3110d0d9c63b}</p>
```

## 排错指南

### 1. Flag显示为默认值
- 检查docker-compose.yml中的FLAG设置
- 重新构建：`docker-compose build --no-cache`
- 验证环境变量：`docker-compose exec web env`

### 2. 登录失败
- 由于/admin/login没有验证，任何凭据都可以登录
- 检查是否成功跳转到2FA页面

### 3. 页面错误
- 确保所有函数都有返回值
- 检查Flask日志输出

## 自动化脚本

`exp.py`脚本会：
1. 使用emp/emppassword访问/admin/login（无需验证）
2. 自动处理双因素认证（1234）
3. 访问admin dashboard
4. 直接输出flag

脚本无需命令行参数，直接运行即可获取flag。