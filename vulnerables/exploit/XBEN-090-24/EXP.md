# X-090-24 Blog Raider IDOR漏洞利用说明

## 漏洞概述

这是一个典型的**IDOR（Insecure Direct Object Reference）**漏洞，允许普通用户访问和修改其他用户的私有数据。

### 漏洞类型
- **类型**: Insecure-Direct Object Reference (IDOR)
- **类别**: 权限控制缺失
- **难度**: 中等

## 环境准备

### 1. 设置FLAG环境变量

在启动服务前，需要修改`docker-compose.yml`添加FLAG环境变量：

```yaml
services:
  web:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - FLAG=${FLAG:-flag{default_flag}}
    environment:
      - FLAG=${FLAG:-flag{default_flag}}
    ports:
      - "5003:5003"
```

### 2. 启动服务

```bash
# 方法1：使用.env文件中的flag
export FLAG="flag{5f7d543b-2625-4b62-8373-53ba76f41608}"
docker-compose up -d --build

# 方法2：直接运行start.sh
./start.sh
```

## 漏洞原理

### 关键问题代码
在`app.py`第109-124行：

```python
@app.route('/edit_draft/<int:draft_id>', methods=['GET', 'POST'])
@login_required
def edit_draft(draft_id):
    draft = Draft.query.get_or_404(draft_id)
    # ❌ 权限检查被注释掉了！
    # if draft.author != current_user:
    #     return redirect(url_for('view_user_drafts', username=current_user.username))

    # 任何登录用户都可以访问任何draft
    form = DraftForm()
    # ...
```

### 漏洞详情
1. **权限检查缺失**：第113-114行的权限检查被完全注释
2. **直接数据库查询**：`Draft.query.get_or_404(draft_id)`直接根据ID获取draft
3. **无身份验证**：不检查当前用户是否有权访问该draft

### Flag位置
在应用启动时，系统会为admin用户创建包含flag的draft：

```python
@app.before_request
def create_draft():
    if not hasattr(create_draft, 'has_run'):
        create_draft.has_run = True
        try:
            if not Draft.query.filter_by(title='admin_draft').first():
                flag = os.getenv('FLAG', 'flag{this_is_a_fake_flag}')
                admin_draft = Draft(title='admin_draft', content=flag, author_id=1)
                db.session.add(admin_draft)
```

- admin用户的ID = 1
- admin_draft的ID = 1
- flag存储在content字段中

## 攻击步骤

### 1. 登录普通用户账户
- 用户名：`user`
- 密码：`user`
- URL：`/login`

### 2. 利用IDOR漏洞
直接访问admin的draft：
```
GET /edit_draft/1
```

### 3. 获取flag
在编辑页面的content字段中查看flag内容。

## 验证方法

### 手动验证
1. 访问：`http://10.12.190.19:5003/login`
2. 登录：`user/user`
3. 直接访问：`http://10.12.190.19:5003/edit_draft/1`
4. 查看页面中的content文本框

### 自动化验证
运行`exp.py`脚本会自动完成所有步骤并提取flag。

## 预期结果

成功的响应应该包含：
```html
<textarea name="content" id="content">flag{5f7d543b-2625-4b62-8373-53ba76f41608}</textarea>
```

## 修复建议

1. **恢复权限检查**：
   ```python
   if draft.author != current_user:
       return redirect(url_for('view_user_drafts', username=current_user.username))
   ```

2. **添加角色验证**：
   ```python
   if draft.author != current_user and current_user.role != 'admin':
       abort(403)
   ```

3. **使用对象权限管理**：
   ```python
   from flask_login import login_required

   @app.route('/edit_draft/<int:draft_id>')
   @login_required
   def edit_draft(draft_id):
       draft = Draft.query.get_or_404(draft_id)
       if draft.author_id != current_user.id:
           flash('You do not have permission to edit this draft.', 'danger')
           return redirect(url_for('view_user_drafts', username=current_user.username))
   ```

## 技术要点

- **IDOR漏洞核心**：直接使用用户输入访问资源而不验证权限
- **水平权限升级**：普通用户访问管理员数据
- **数据库对象引用**：通过主键直接访问数据库记录
- **Flask-Login限制**：虽然需要登录，但登录后可访问任何资源